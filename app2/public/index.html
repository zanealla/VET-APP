<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>M√©dicaments V√©t√©rinaires</title>

  <!-- jsPDF + autotable (for PDF export) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

  <style>
.sticky-header {
  position: sticky;
  top: 0;
  z-index: 100;
  background: null;
  padding: 20px 0;
  transition: all 0.3s ease;
}
    .dropdown {
      margin-left: 85%;
      margin-bottom: 10px;
    }
    .info-value {
      color: #333;
      font-weight: bold;
    }
    .info-label {
      color: #666;
      font-weight: 500;
    }
    .info-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #f0f0f0;
    }
    .category-badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 8px;
      font-size: 0.85rem;
      font-weight: 500;
      margin-left: 8px;
      color: white;
    }

    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;padding:20px}
    .container{max-width:1200px;margin:0 auto}
    .header{background:white;padding:30px;border-radius:20px;box-shadow:0 10px 40px rgba(0,0,0,.1);margin-bottom:30px;text-align:center}
    .header h1{color:#667eea;font-size:2.5em;margin-bottom:10px}
    .header p{color:#666;font-size:1.1em}
    .controls{background:white;padding:20px;border-radius:15px;box-shadow:0 5px 20px rgba(0,0,0,.1);margin-bottom:20px;display:flex;gap:15px;flex-wrap:wrap;align-items:center}
    .search-box{flex:1;min-width:250px}
    .search-box input{width:100%;padding:12px 20px;border:2px solid #e0e0e0;border-radius:10px;font-size:16px;transition:all .3s}
    .search-box input:focus{outline:none;border-color:#667eea;box-shadow:0 0 0 3px rgba(102,126,234,.1)}
    .filter-group{display:flex;gap:10px;align-items:center}
    select{padding:12px 20px;border:2px solid #e0e0e0;border-radius:10px;font-size:16px;background:white;cursor:pointer;transition:all .3s}
    .add-btn{background:#667eea;color:white;padding:12px 30px;border:none;border-radius:10px;font-size:16px;font-weight:bold;cursor:pointer;transition:all .3s}
    .add-btn:hover{background:#5568d3;transform:translateY(-2px);box-shadow:0 5px 15px rgba(102,126,234,.3)}
    .medicine-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:20px;margin-bottom:20px}
    .medicine-card{background:white;border-radius:15px;padding:25px;box-shadow:0 5px 20px rgba(0,0,0,.1);transition:all .3s;position:relative;overflow:hidden}
    .medicine-card:hover{transform:translateY(-5px);box-shadow:0 10px 30px rgba(0,0,0,.15)}
    .medicine-card::before{content:'';position:absolute;top:0;left:0;width:5px;height:100%;background:linear-gradient(180deg,#667eea,#764ba2)}
    .medicine-header{display:flex;justify-content:space-between;align-items:start;margin-bottom:15px}
    .medicine-name{font-size:1.3em;font-weight:bold;color:#333;flex:1}
    .price{text-align:center;font-size:1.5em;color:#667eea;font-weight:bold;margin:15px 30px;transition:color .3s,transform .3s}
    .flash-green{color:#22c55e;transform:scale(1.12)}
    .flash-red{color:#ef4444;transform:scale(1.12)}
    .quick-buttons{display:flex;flex-wrap:wrap;gap:8px;margin-top:6px}
    .btn-percent{flex:1;min-width:50px;background:#f1f3f6;border:1px solid #e0e0e0;border-radius:8px;padding:8px 10px;cursor:pointer;font-weight:bold;color:#555;transition:all .3s}
    .btn-percent:hover{background:#667eea;color:white;border-color:#667eea}
    .select-percent{width:100%;padding:8px;border-radius:8px;border:1px solid #ddd;background:#f9fafb;font-weight:bold;color:#555;cursor:pointer;margin-top:8px}
    @media(max-width:600px){.quick-buttons{display:none}.select-percent{display:block}}
    @media(min-width:601px){.select-percent{display:none}}
    .medicine-actions{display:flex;gap:10px;margin-top:15px}
    .btn{flex:1;padding:10px;border:none;border-radius:8px;font-weight:bold;cursor:pointer;transition:all .3s}
    .btn-edit{background:#667eea;color:white}
    .btn-edit:hover{background:#5568d3}
    .btn-delete{background:#f44336;color:white}
    .btn-delete:hover{background:#da190b}
    .modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.4);display:none;align-items:center;justify-content:center;z-index:1000;backdrop-filter: blur(3px)}
    .modal.active{display:flex;animation:fadeIn .18s ease-in-out}
    @keyframes fadeIn{from{opacity:0;transform:scale(.98)}to{opacity:1;transform:scale(1)}}
    .modal-content{background:white;border-radius:15px;padding:30px;max-width:480px;width:90%;max-height:90vh;overflow:auto}
    .modal-header{font-size:1.4em;font-weight:bold;color:#667eea;margin-bottom:18px}
    .form-group{margin-bottom:15px}
    .form-group label{display:block;margin-bottom:6px;font-weight:600;color:#333}
    .form-group input,.form-group select{width:100%;padding:10px;border-radius:8px;border:2px solid #e0e0e0;font-size:15px}
    .modal-actions{display:flex;gap:10px;margin-top:16px}
    .btn-save{flex:1;background:#667eea;color:white;border:none;padding:10px;border-radius:8px;font-weight:bold}
    .btn-cancel{flex:1;background:#ccc;color:#333;border:none;padding:10px;border-radius:8px;font-weight:bold}
    .empty-state{background:white;border-radius:15px;padding:60px;text-align:center;color:#999}
    
    /* Image upload styles */
    .image-upload-container {
      margin-bottom: 15px;
    }
    .image-upload-label {
      display: block;
      margin-bottom: 6px;
      font-weight: 600;
      color: #333;
    }
    .image-upload-area {
      border: 2px dashed #e0e0e0;
      border-radius: 8px;
      padding: 20px;
      text-align: center;
      transition: all 0.3s;
      cursor: pointer;
      background: #f9fafb;
    }
    .image-upload-area:hover, .image-upload-area.dragover {
      border-color: #667eea;
      background: rgba(102,126,234,0.05);
    }
    .image-upload-icon {
      font-size: 40px;
      color: #667eea;
      margin-bottom: 10px;
    }
    .image-upload-text {
      color: #666;
      margin-bottom: 10px;
    }
    .image-upload-hint {
      font-size: 12px;
      color: #999;
    }
    .image-preview-container {
      margin-top: 15px;
      text-align: center;
    }
    .image-preview {
      max-width: 100%;
      max-height: 200px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin-bottom: 10px;
    }
    .remove-image-btn {
      background: #f44336;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 6px 12px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s;
    }
    .remove-image-btn:hover {
      background: #da190b;
    }
    .medicine-image {
      width: 100%;
      height: 150px;
      object-fit: contain;
      border-radius: 8px;
      margin-bottom: 15px;
      background: #f9fafb;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .medicine-image img {
      max-width: 100%;
      max-height: 150px;
      border-radius: 8px;
    }
    .placeholder-icon {
      font-size: 40px;
      color: #ccc;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üè• M√©dicaments V√©t√©rinaires</h1>
      <p>Gestion de la liste des m√©dicaments et leurs prix</p>
    </div>
<div class="sticky-header">
    <div class="controls">
      <div class="search-box">
        <input id="searchInput" type="text" placeholder="üîç Rechercher un m√©dicament...">
      </div>

      <div class="filter-group">
        <select id="categoryFilter"></select>
        <select id="sortBy">
          <option value="name">Trier par nom</option>
          <option value="price-asc">Prix croissant</option>
          <option value="price-desc">Prix d√©croissant</option>
        </select>
      </div>
     <button class="add-btn" onclick="openModal()">+ Ajouter</button>
      <button class="add-btn" style="background:#4CAF50" onclick="exportPDF()">üìÑ Exporter en PDF</button>
    </div>
    
    <div class="dropdown" style="position: relative; display: inline-block;">
      <button id="manageCategoriesBtn" 
        style="background: linear-gradient(90deg, #6b46c1, #805ad5); 
               color: white; border: none; padding: 8px 14px; border-radius: 8px; 
               cursor: pointer; font-weight: bold; transition: all 0.25s;">
        ‚öôÔ∏è G√©rer les cat√©gories
      </button>

      <div id="manageCategoriesMenu" 
        style="display: none; position: absolute; right: 0; background: white; 
               box-shadow: 0 6px 20px rgba(0,0,0,0.15); border-radius: 10px; 
               padding: 12px; min-width: 240px; z-index: 1000;">
        <h4 style="margin-top: 0; font-size: 14px; text-align: center; color: #4a4a4a;">Cat√©gories</h4>
        <ul id="categoryList" style="list-style: none; padding: 0; margin: 0; max-height: 200px; overflow-y: auto;"></ul>
        <hr style="margin: 10px 0;">
        <button id="addCategoryQuick" 
          style="width: 100%; background: linear-gradient(90deg, #667eea, #764ba2); 
                 color: white; border: none; border-radius: 6px; padding: 6px 10px; 
                 cursor: pointer; font-weight: 500;">
          Ôºã Ajouter
        </button>
      </div>
    </div> 
	    </div> 

    <div id="medicineGrid" class="medicine-grid"></div>

    <div id="emptyState" class="empty-state" style="display:none;">
      <h2>Aucun m√©dicament trouv√©</h2>
      <p>Ajoutez votre premier m√©dicament pour commencer</p>
    </div>
  </div>

  <!-- Modal -->
  <div id="modal" class="modal" onclick="if(event.target===this) closeModal()">
    <div class="modal-content">
      <div id="modalTitle" class="modal-header">Ajouter un m√©dicament</div>
      <form id="medicineForm">
        <div class="form-group">
          <label>Nom du m√©dicament</label>
          <input id="medicineName" type="text" required>
        </div>

        <div class="form-group">
          <label>Cat√©gorie</label>
          <div style="display:flex; gap:8px; align-items:center;">
            <select id="medicineCategory" required style="flex:1;"></select>
            <button type="button" id="addCategoryBtn"
              style="background:#667eea;color:white;border:none;border-radius:8px;padding:8px 12px;font-weight:bold;cursor:pointer;">Ôºã</button>
          </div>
        </div>

        <div class="form-group">
          <label>Prix (DA)</label>
          <input id="medicinePrice" type="number" step="0.01" required>
        </div>
        
	    <div class="form-group">
   <label for="medicineStock">Stock:</label>
   <input type="number" id="medicineStock" name="stock" value="0" min="0" step="1">
</div>
		
        <div class="form-group">
          <label>Dosage</label>
          <input id="medicineDosage" type="text" placeholder="Ex: 10ml, 500mg">
        </div>
        
        <div class="form-group">
          <label>Fabricant</label>
          <input id="medicineManufacturer" type="text">
        </div>
        
        <!-- Image Upload Section -->
        <div class="image-upload-container">
          <label class="image-upload-label">Image du produit</label>
          <div id="imageUploadArea" class="image-upload-area">
            <div class="image-upload-icon">üì∑</div>
            <div class="image-upload-hint">Formats support√©s: JPEG, PNG, GIF, WEBP, AVIF (Max. 2MB)</div>
            <input type="file" id="imageInput" accept="image/jpeg,image/png,image/gif,image/webp,image/avif" style="display:none">
          </div>
          <div id="imagePreviewContainer" class="image-preview-container" style="display:none">
            <img id="imagePreview" class="image-preview" src="" alt="Aper√ßu de l'image">
            <button type="button" id="removeImageBtn" class="remove-image-btn">Supprimer l'image</button>
          </div>
        </div>
        
        <div class="modal-actions">
          <button type="submit" class="btn-save">Enregistrer</button>
          <button type="button" class="btn-cancel" onclick="closeModal()">Annuler</button>
        </div>
      </form>
    </div>
  </div>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    /* ---------------- CATEGORY SYSTEM (Backend Connected) ---------------- */

/* ---------------- CATEGORY SYSTEM (Backend Connected) ---------------- */

async function getCategories() {
  try {
    const response = await fetch('/api/categories');
    if (!response.ok) throw new Error('Failed to fetch categories');
    const categories = await response.json();
    return categories;
  } catch (error) {
    console.error('Error fetching categories:', error);
    // Fallback to default categories if backend fails
    return ['Antiparasitaire', 'Antibiotique', 'Vitamine', 'Anti-inflammatoire', 'Vaccin', 'D√©sinfectant', 'Consumables'];
  }
}

async function addCategory(newCategory) {
  try {
    const response = await fetch('/api/categories', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ name: newCategory })
    });
    if (!response.ok) throw new Error('Failed to add category');
    return await response.json();
  } catch (error) {
    console.error('Error adding category:', error);
    throw error;
  }
}

async function updateCategory(oldName, newName) {
  try {
    const response = await fetch(`/api/categories/${encodeURIComponent(oldName)}`, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ newName })
    });
    if (!response.ok) throw new Error('Failed to update category');
    return await response.json();
  } catch (error) {
    console.error('Error updating category:', error);
    throw error;
  }
}

async function deleteCategory(categoryName) {
  try {
    const response = await fetch(`/api/categories/${encodeURIComponent(categoryName)}`, {
      method: 'DELETE'
    });
    if (!response.ok) throw new Error('Failed to delete category');
    return await response.json();
  } catch (error) {
    console.error('Error deleting category:', error);
    throw error;
  }
}

async function populateCategorySelects() {
  try {
    const cats = await getCategories();
    const categorySelect = document.getElementById("medicineCategory");
    const filterSelect = document.getElementById("categoryFilter");

    // medicineCategory: first option empty to force selection when adding
    categorySelect.innerHTML = '';
    const placeholder = new Option("-- Choisir ou cr√©er --", "");
    placeholder.disabled = true;
    placeholder.selected = true;
    categorySelect.appendChild(placeholder);

    // filter: include "all"
    filterSelect.innerHTML = '';
    filterSelect.appendChild(new Option("Toutes", "all"));

    cats.forEach(cat => {
      categorySelect.appendChild(new Option(cat, cat));
      filterSelect.appendChild(new Option(cat, cat));
    });
  } catch (error) {
    console.error('Error populating category selects:', error);
  }
}

// Update the addCategoryBtn event listener
document.getElementById('addCategoryBtn').addEventListener('click', async () => {
  const newCat = prompt("Nom de la nouvelle cat√©gorie :")?.trim();
  if (!newCat) return;
  
  try {
    await addCategory(newCat);
    await populateCategorySelects();
    document.getElementById("medicineCategory").value = newCat;
  } catch (error) {
    alert("Erreur lors de l'ajout de la cat√©gorie : " + error.message);
  }
});

    /* --------------- Image Upload Functions --------------- */
    const imageUploadArea = document.getElementById('imageUploadArea');
    const imageInput = document.getElementById('imageInput');
    const imagePreviewContainer = document.getElementById('imagePreviewContainer');
    const imagePreview = document.getElementById('imagePreview');
    const removeImageBtn = document.getElementById('removeImageBtn');
    
    let currentImageData = null;

    // Click to upload
    imageUploadArea.addEventListener('click', () => {
      imageInput.click();
    });

    // Drag and drop functionality
    imageUploadArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      imageUploadArea.classList.add('dragover');
    });

    imageUploadArea.addEventListener('dragleave', () => {
      imageUploadArea.classList.remove('dragover');
    });

    imageUploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      imageUploadArea.classList.remove('dragover');
      
      if (e.dataTransfer.files.length) {
        const file = e.dataTransfer.files[0];
        if (validateImageFile(file)) {
          readImageFile(file);
        }
      }
    });

    // File input change
    imageInput.addEventListener('change', (e) => {
      if (e.target.files.length) {
        const file = e.target.files[0];
        if (validateImageFile(file)) {
          readImageFile(file);
        }
      }
    });

    // Remove image
    removeImageBtn.addEventListener('click', () => {
      currentImageData = null;
      imagePreviewContainer.style.display = 'none';
      imageInput.value = '';
    });

    // Validate image file
   function validateImageFile(file) {
  // Add 'image/avif' to this array
  const validTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp', 'image/avif'];
  
  const maxSize = 2 * 1024 * 1024; // 2MB
  
  if (!validTypes.includes(file.type)) {
    // Update the error message
    alert('Veuillez s√©lectionner une image au format JPEG, PNG, GIF, WEBP ou AVIF.');
    return false;
  }
      
      if (file.size > maxSize) {
        alert('La taille de l\'image ne doit pas d√©passer 2MB.');
        return false;
      }
      
      return true;
    }

    // Read image file and convert to base64
    function readImageFile(file) {
      const reader = new FileReader();
      
      reader.onload = (e) => {
        currentImageData = e.target.result;
        imagePreview.src = currentImageData;
        imagePreviewContainer.style.display = 'block';
      };
      
      reader.readAsDataURL(file);
    }

    /* --------------- Utilities --------------- */
    function deterministicColorFromString(str){
      // simple deterministic H value from a hash of the string
      let h = 0;
      for(let i=0;i<str.length;i++) h = (h*31 + str.charCodeAt(i)) | 0;
      h = Math.abs(h) % 360;
      const saturation = 60;
      const lightness = 45;
      return `hsl(${h}deg ${saturation}% ${lightness}%)`;
    }

    function formatPrice(value) {
      const number = Math.round((Number(value) || 0) * 100) / 100;
      // Use fr-FR to get comma decimals, then replace NBSP with normal space
      return number
        .toLocaleString('fr-FR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })
        .replace(/\u202F|\u00A0/g, ' ') + ' DA';
    }

    /* --------------- State --------------- */
    const temporaryAdjustments = {}; // { id: percent }
    let medicines = [];     // will be fetched from server
    let editingId = null;

    /* --------------- Fetch / CRUD (unchanged endpoints) --------------- */
    async function fetchMedicines(){
      try {
        const res = await fetch('/api/medicines');
        if (!res.ok) throw new Error('Erreur r√©seau');
        medicines = await res.json();
      } catch(e){
        console.warn('fetchMedicines: fallback empty', e);
        medicines = [];
      }
      // ensure originalPrice exists
      medicines = medicines.map(m => ({ ...m, originalPrice: (m.originalPrice ?? m.price ?? 0) }));
      renderMedicines();
    }

    async function saveMedicineToServer(medicine){
      try {
        if (editingId) {
          await fetch(`/api/medicines/${editingId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(medicine),
          });
        } else {
          await fetch('/api/medicines', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(medicine),
          });
        }
        editingId = null;
        await fetchMedicines();
      } catch(err){
        alert('Erreur lors de la sauvegarde: ' + err.message);
      }
    }

   /* --------------- Delete Medicine Function --------------- */
window.deleteMedicine = async function(id){
  if (!confirm("√ätes-vous s√ªr de vouloir supprimer ce m√©dicament ?")) return;
  try {
    const response = await fetch(`/api/medicines/${id}`, { 
      method: 'DELETE' 
    });
    
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    
    delete temporaryAdjustments[id];
    await fetchMedicines();
  } catch(err){
    console.error('Delete error:', err);
    alert('Erreur lors de la suppression: ' + err.message);
  }
};

    /* --------------- Render --------------- */
    function displayPriceFor(med){
      const p = temporaryAdjustments[med.id];
      if (typeof p === 'number') {
        return Math.round(med.originalPrice * (1 + p/100) * 100) / 100;
      }
      return med.price ?? med.originalPrice ?? 0;
    }

    function renderMedicines(){
      const grid = document.getElementById('medicineGrid');
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      const categoryFilter = document.getElementById('categoryFilter').value;
      const sortBy = document.getElementById('sortBy').value;

      let filtered = medicines.filter(med => {
        const matchesSearch = med.name?.toLowerCase().includes(searchTerm) || (med.manufacturer || '').toLowerCase().includes(searchTerm);
        const matchesCategory = categoryFilter === 'all' || !categoryFilter || med.category === categoryFilter;
        return matchesSearch && matchesCategory;
      });

      if (sortBy === 'name') filtered.sort((a,b)=> (a.name||'').localeCompare(b.name||''));
      else if (sortBy === 'price-asc') filtered.sort((a,b)=> displayPriceFor(a) - displayPriceFor(b));
      else if (sortBy === 'price-desc') filtered.sort((a,b)=> displayPriceFor(b) - displayPriceFor(a));

      if (!filtered.length) {
        grid.style.display = 'none';
        document.getElementById('emptyState').style.display = 'block';
        return;
      }
      grid.style.display = 'grid';
      document.getElementById('emptyState').style.display = 'none';

      grid.innerHTML = filtered.map(med => {
        const displayPrice = displayPriceFor(med);
        // badge with inline color
        const badgeColor = deterministicColorFromString(med.category || 'Autre');
        const badgeHtml = `<span class="category-badge" style="background:${badgeColor}">${med.category || '‚Äî'}</span>`;
        
        // Image display
        const imageHtml = med.image 
          ? `<img src="${med.image}" alt="${escapeHtml(med.name || 'M√©dicament')}">`
          : `<div class="placeholder-icon">üíä</div>`;

        return `
          <div class="medicine-card" data-id="${med.id}">
            <div class="medicine-image">
              ${imageHtml}
            </div>
            
            <div class="medicine-header">
              <div class="medicine-name">${escapeHtml(med.name || '-')} ${badgeHtml}</div>
            </div>

            <div class="medicine-info">
			  <div class="info-row"><span class="info-label">Stock:</span><span class="info-value">${med.stock || 0}</span></div>
              <div class="info-row"><span class="info-label">Dosage:</span><span class="info-value">${escapeHtml(med.dosage || '-')}</span></div>
              <div class="info-row"><span class="info-label">Fabricant:</span><span class="info-value">${escapeHtml(med.manufacturer || '-')}</span></div>
              <div class="info-row"><span class="info-label">Prix (base):</span><span class="info-value">${formatPrice(med.originalPrice)}</span></div>
            </div>

            <div class="price ${temporaryAdjustments[med.id] === 0 ? 'flash-red' : (temporaryAdjustments[med.id] ? 'flash-green' : '') }" id="price-${med.id}">
              ${formatPrice(displayPrice)}
            </div>

            <div class="quick-buttons" aria-hidden="false">
              ${[0,1,3,5,10,20,30].map(p => `<button class="btn-percent" onclick="applyTempPercent(${med.id}, ${p})">${p}%</button>`).join('')}
            </div>

            <select class="select-percent" onchange="applyTempPercent(${med.id}, this.value)">
              <option value="">Changer par %</option>
              ${[0,1,3,5,10,20,30].map(p => `<option value="${p}">${p}%</option>`).join('')}
            </select>

            <div class="medicine-actions">
              <button class="btn btn-edit" onclick="startEdit(${med.id})">‚úèÔ∏è Modifier</button>
              <button class="btn btn-delete" onclick="deleteMedicine(${med.id})">üóëÔ∏è Supprimer</button>
            </div>
          </div>
        `;
      }).join('');
    }

    // small helper to avoid injecting HTML from data
    function escapeHtml(text) {
      return String(text)
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'",'&#039;');
    }

    // expose safe functions to global for inline onclicks (applyTempPercent, startEdit)
    window.applyTempPercent = function(id, percent) {
      percent = parseFloat(percent);
      if (isNaN(percent)) return;
      const med = medicines.find(m=>m.id===id);
      if (!med) return;
      temporaryAdjustments[id] = percent;
      const display = document.getElementById(`price-${id}`);
      const newPrice = Math.round(med.originalPrice * (1 + percent/100) * 100) / 100;
      if (display) display.textContent = formatPrice(newPrice);
      // flash
      if (display) {
        display.classList.remove('flash-green','flash-red');
        void display.offsetWidth;
        display.classList.add(percent === 0 ? 'flash-red' : 'flash-green');
        setTimeout(()=>display.classList.remove('flash-green','flash-red'), 600);
      }
    };

    window.startEdit = function(id){
      const med = medicines.find(m=>m.id===id);
      if (!med) return;
      editingId = id;
      document.getElementById('modalTitle').textContent = 'Modifier le m√©dicament';
      document.getElementById('medicineName').value = med.name || '';
      document.getElementById('medicineCategory').value = med.category || '';
      document.getElementById('medicinePrice').value = med.originalPrice ?? med.price ?? '';
	  document.getElementById('medicineStock').value = med.stock || 0;
      document.getElementById('medicineDosage').value = med.dosage || '';
      document.getElementById('medicineManufacturer').value = med.manufacturer || '';
      
      // Set image if exists
      if (med.image) {
        currentImageData = med.image;
        imagePreview.src = currentImageData;
        imagePreviewContainer.style.display = 'block';
      } else {
        currentImageData = null;
        imagePreviewContainer.style.display = 'none';
      }
      
      document.getElementById('modal').classList.add('active');
    };

    /* --------------- Modal / form --------------- */
    function openModal(){
      editingId = null;
      document.getElementById('modalTitle').textContent = 'Ajouter un m√©dicament';
      document.getElementById('medicineForm').reset();
      // set default on category select to placeholder
      const catSelect = document.getElementById('medicineCategory');
      if (catSelect) catSelect.selectedIndex = 0;
      
      // Reset image upload
      currentImageData = null;
      imagePreviewContainer.style.display = 'none';
      imageInput.value = '';
      
      document.getElementById('modal').classList.add('active');
    }
    window.openModal = openModal;
    function closeModal(){ document.getElementById('modal').classList.remove('active'); }
    window.closeModal = closeModal;

    document.getElementById('medicineForm').addEventListener('submit', async (ev) => {
      ev.preventDefault();
      const medicine = {
        name: document.getElementById('medicineName').value.trim(),
        category: document.getElementById('medicineCategory').value,
        price: parseFloat(document.getElementById('medicinePrice').value) || 0,
        stock: parseInt(document.getElementById('medicineStock').value, 10) || 0,
		dosage: document.getElementById('medicineDosage').value.trim(),
        manufacturer: document.getElementById('medicineManufacturer').value.trim(),
        originalPrice: parseFloat(document.getElementById('medicinePrice').value) || 0
      };
      
      // Add image data if available
      if (currentImageData) {
        medicine.image = currentImageData;
      }
      
      await saveMedicineToServer(medicine);
      // clear temp adjustments & close
      Object.keys(temporaryAdjustments).forEach(k => delete temporaryAdjustments[k]);
      closeModal();
    });

    /* --------------- PDF export --------------- */
   async function exportPDF() {
  let data = [];
  try {
    const res = await fetch('/api/medicines');
    if (!res.ok) throw new Error('Erreur r√©seau');
    data = await res.json();
  } catch (err) {
    alert('Impossible de charger les donn√©es pour le PDF: ' + err.message);
    return;
  }

  // Attempt logo
  async function loadImageDataURL(path) {
    try {
      const resp = await fetch(path);
      if (!resp.ok) throw new Error('logo not found');
      const blob = await resp.blob();
      return await new Promise((resolve,reject)=>{
        const reader = new FileReader();
        reader.onload = ()=>resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(blob);
      });
    } catch(e){
      return null;
    }
  }

  const logoPath = '/logo.png';
  const logoDataUrl = await loadImageDataURL(logoPath);

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ unit: 'pt', format: 'a4' });

  // Variables pour le style
  const margin = 40;
  const pageWidth = doc.internal.pageSize.getWidth();
  const contentWidth = pageWidth - (margin * 2);
  let y = 40;

  // Couleurs du th√®me
  const primaryColor = [238, 238, 238];
  const secondaryColor = [118, 75, 162];
  const lightGray = [245, 245, 245];
  const darkGray = [51, 51, 51];
  const borderColor = [220, 220, 220];

  // En-t√™te avec d√©grad√©
  doc.setFillColor(primaryColor[0], primaryColor[1], primaryColor[2]);
  doc.rect(0, 0, pageWidth, 120, 'F');
  
  // Logo et titre
  if (logoDataUrl) {
    try {
      const img = new Image();
      img.src = logoDataUrl;
      await new Promise((res)=>{ img.onload = res; img.onerror = res; });
      const imgW = img.width || 50;
      const imgH = img.height || 50;
      const targetH = 50;
      const targetW = (imgW / imgH) * targetH;
      doc.addImage(logoDataUrl, 'PNG', margin, 35, targetW, targetH);
      
      doc.setFontSize(20);
      doc.setTextColor(238, 238, 238);
      doc.setFont("helvetica", "bold");
      doc.text('LISTE DES M√âDICAMENTS V√âT√âRINAIRES', margin + targetW + 15, 60);
      
      doc.setFontSize(10);
      doc.setTextColor(255, 255, 255, 0.8);
      doc.setFont("helvetica", "normal");
      doc.text(`G√©n√©r√© le ${new Date().toLocaleDateString('fr-FR')}`, margin + targetW + 15, 75);
    } catch(e){
      // Fallback sans logo
      doc.setFontSize(20);
      doc.setTextColor(255, 255, 255);
      doc.setFont("helvetica", "bold");
      doc.text('LISTE DES M√âDICAMENTS V√âT√âRINAIRES', margin, 60);
      
      doc.setFontSize(10);
      doc.setTextColor(255, 255, 255, 0.8);
      doc.setFont("helvetica", "normal");
      doc.text(`G√©n√©r√© le ${new Date().toLocaleDateString('fr-FR')}`, margin, 75);
    }
  } else {
   doc.setFontSize(20);
doc.setTextColor(0, 0, 0);
doc.setFont("helvetica", "bold");
doc.text('LISTE DES M√âDICAMENTS V√âT√âRINAIRES', pageWidth / 2, 60, { align: 'center' });

doc.setFontSize(10);
doc.setTextColor(255, 255, 255, 0.8);
doc.setFont("helvetica", "normal");
doc.text(`G√©n√©r√© le ${new Date().toLocaleDateString('fr-FR')}`, pageWidth / 2, 75, { align: 'center' });
  }

  // Statistiques rapides
  const totalMeds = data.length;
  const uniqueCategories = [...new Set(data.map(m => m.category))].filter(Boolean).length;
  const totalValue = data.reduce((sum, m) => sum + (m.originalPrice ?? m.price ?? 0), 0);
  
  y = 140;
  
  // Boxes de statistiques
  const statBoxWidth = (contentWidth - 20) / 3;
  
 // Box 1: Total m√©dicaments
doc.setFillColor(lightGray[0], lightGray[1], lightGray[2]);
doc.roundedRect(margin, y, statBoxWidth, 50, 3, 3, 'F');
const centerX1 = margin + (statBoxWidth / 2);
doc.setFontSize(12);
doc.setTextColor(0, 0, 0);
doc.setFont("helvetica", "bold");
doc.text('TOTAL M√âDICAMENTS', centerX1, y + 15, { align: 'center' });
doc.setFontSize(16);
doc.setTextColor(0, 0, 0);
doc.setFont("helvetica", "bold");
doc.text(totalMeds.toString(), centerX1, y + 35, { align: 'center' });

// Box 2: Cat√©gories
doc.setFillColor(lightGray[0], lightGray[1], lightGray[2]);
doc.roundedRect(margin + statBoxWidth + 10, y, statBoxWidth, 50, 3, 3, 'F');
const centerX2 = margin + statBoxWidth + 10 + (statBoxWidth / 2);
doc.setFontSize(12);
doc.setTextColor(0, 0, 0);
doc.setFont("helvetica", "bold");
doc.text('CAT√âGORIES', centerX2, y + 15, { align: 'center' });
doc.setFontSize(16);
doc.setTextColor(0, 0, 0);
doc.setFont("helvetica", "bold");
doc.text(uniqueCategories.toString(), centerX2, y + 35, { align: 'center' });

// Box 3: Valeur totale
doc.setFillColor(lightGray[0], lightGray[1], lightGray[2]);
doc.roundedRect(margin + (statBoxWidth * 2) + 20, y, statBoxWidth, 50, 3, 3, 'F');
const centerX3 = margin + (statBoxWidth * 2) + 20 + (statBoxWidth / 2);
doc.setFontSize(12);
doc.setTextColor(0, 0, 0);
doc.setFont("helvetica", "bold");
doc.text('VALEUR TOTALE', centerX3, y + 15, { align: 'center' });
doc.setFontSize(14);
doc.setTextColor(0, 0, 0);
doc.setFont("helvetica", "bold");
doc.text(formatPrice(totalValue), centerX3, y + 35, { align: 'center' });

y += 70;

  // Tableau des m√©dicaments
  const body = data.map(m => [
    m.name || '-',
    m.category || '-',
    m.dosage || '-',
    m.manufacturer || '-',
    formatPrice(m.originalPrice ?? m.price ?? 0)
  ]);

  doc.autoTable({
    startY: y,
    head: [['Nom', 'Cat√©gorie', 'Dosage', 'Fabricant', 'Prix (base)']],
    body: body,
    styles: { 
      fontSize: 9, 
      cellPadding: 6,
      lineColor: borderColor,
      lineWidth: 0.5,
      textColor: darkGray
    },
    headStyles: { 
      fillColor: [238, 238, 238],
      textColor: 0,
      fontStyle: 'bold',
      lineWidth: 0.5,
      lineColor: borderColor
    },
    alternateRowStyles: {
      fillColor: [249, 249, 249]
    },
    columnStyles: {
      0: { cellWidth: 'auto', fontStyle: 'bold' },
      1: { cellWidth: 'auto' },
      2: { cellWidth: 'auto' },
      3: { cellWidth: 'auto' },
      4: { cellWidth: 'auto', halign: 'right' }
    },
    margin: { left: margin, right: margin, bottom: 60 },
    didDrawPage: function(data) {
      // Pied de page
      doc.setFontSize(8);
      doc.setTextColor(150, 150, 150);
      doc.text('¬© ' + new Date().getFullYear() + ' - Cabinet V√©t√©rinaire', margin, doc.internal.pageSize.height - 20);
      doc.text('Page ' + (doc.internal.getNumberOfPages()) + ' sur ' + doc.internal.getNumberOfPages(), pageWidth - margin - 30, doc.internal.pageSize.height - 20, { align: 'right' });
    },
    willDrawCell: function(data) {
      // Style sp√©cial pour la colonne prix
      if (data.column.index === 4 && data.cell.section === 'body') {
        doc.setTextColor(0, 0, 0); // pour les prix
		 doc.setFont(undefined, 'bold'); // Texte en gras
      }
    }
  });

  // Ajouter un filigrane si peu de donn√©es
  if (data.length <= 5) {
    const pageHeight = doc.internal.pageSize.getHeight();
    doc.setFontSize(60);
    doc.setTextColor(240, 240, 240);
    doc.setGState(new doc.GState({ opacity: 0.1 }));
    doc.text('V√âT√âRINAIRE', pageWidth / 2, pageHeight / 2, { 
      align: 'center', 
      angle: 45 
    });
    doc.setGState(new doc.GState({ opacity: 1 }));
  }

  doc.save('Liste_Medicaments_Veterinaires_' + new Date().toISOString().slice(0,10) + '.pdf');
}
window.exportPDF = exportPDF;


    /* --------------- Init event listeners --------------- */
    document.getElementById('searchInput').addEventListener('input', renderMedicines);
    document.getElementById('categoryFilter').addEventListener('change', renderMedicines);
    document.getElementById('sortBy').addEventListener('change', renderMedicines);

    // load categories + data and render
    populateCategorySelects();
    fetchMedicines();

    // --- BACKEND CATEGORY MANAGEMENT ---
    const manageBtn = document.getElementById("manageCategoriesBtn");
    const menu = document.getElementById("manageCategoriesMenu");
    const addQuick = document.getElementById("addCategoryQuick");

    // Toggle dropdown
    manageBtn.addEventListener("click", () => {
      menu.style.display = menu.style.display === "block" ? "none" : "block";
      if (menu.style.display === "block") refreshCategoryList();
    });

    // Close when clicking outside
    document.addEventListener("click", (e) => {
      if (!menu.contains(e.target) && e.target !== manageBtn) {
        menu.style.display = "none";
      }
    });

    // Add category
    addQuick.addEventListener("click", async () => {
      const newCat = prompt("Nouvelle cat√©gorie:")?.trim();
      if (!newCat) return;
      
      try {
        await addCategory(newCat);
        await populateCategorySelects();
        refreshCategoryList();
      } catch (error) {
        alert("Erreur lors de l'ajout de la cat√©gorie : " + error.message);
      }
    });

    // Refresh category list in management dropdown
    async function refreshCategoryList() {
      try {
        const cats = await getCategories();
        const list = document.getElementById("categoryList");
        list.innerHTML = "";
        
        cats.forEach(cat => {
          const categoryName = typeof cat === 'string' ? cat : cat.name;
          const li = document.createElement("li");
          li.style.padding = "6px 0";
          li.innerHTML = `
            <span style="font-size:14px;">${categoryName}</span>
            <button onclick="renameCat('${categoryName}')" style="margin:0 5px; background:none; border:none; cursor:pointer;">‚úèÔ∏è</button>
            <button onclick="deleteCat('${categoryName}')" style="background:none; border:none; cursor:pointer;">üóëÔ∏è</button>
          `;
          list.appendChild(li);
        });
      } catch (error) {
        console.error('Error refreshing category list:', error);
      }
    }

    // Global functions for category operations
    window.renameCat = async function(cat) {
      const newName = prompt("Nouveau nom:", cat)?.trim();
      if (!newName || newName === cat) return;
      
      try {
        await updateCategory(cat, newName);
        await populateCategorySelects();
        refreshCategoryList();
        // Also refresh medicines to update category names in medicine cards
        await fetchMedicines();
      } catch (error) {
        alert("Erreur lors du renommage : " + error.message);
      }
    };

    window.deleteCat = async function(cat) {
      if (confirm(`Supprimer "${cat}" ? Cette action ne supprimera pas les m√©dicaments de cette cat√©gorie, mais leur cat√©gorie sera vide.`)) {
        try {
          await deleteCategory(cat);
          await populateCategorySelects();
          refreshCategoryList();
        } catch (error) {
          alert("Erreur lors de la suppression : " + error.message);
        }
      }
    };
  });
  
  </script>
</body>
</html>