<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>G√©n√©rateur de Facture - Stacked</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap">
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
/* Image upload styles */
#imagePreview {
    transition: all 0.3s ease;
}

#previewImage {
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    object-fit: contain;
}

#productImageUpload {
    padding: 8px;
    border: 2px dashed #667eea;
    border-radius: 8px;
    background: #f8f9fa;
    transition: all 0.3s ease;
}

#productImageUpload:hover {
    border-color: #5568d3;
    background: #f0f2ff;
}

#productImageUpload::file-selector-button {
    background: #667eea;
    color: white;
    border: none;
    padding: 8px 12px;
    border-radius: 4px;
    cursor: pointer;
    margin-right: 10px;
}

#productImageUpload::file-selector-button:hover {
    background: #5568d3;
}
input.item-qty {
    MARGIN-LEFT: -70%;
    width: 170%;
}
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin: 20px 0;
}

.stat-card {
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    text-align: center;
}

.stat-card h3 {
    margin: 0 0 10px 0;
    font-size: 14px;
    color: #666;
    text-transform: uppercase;
}

.stat-value {
    font-size: 24px;
    font-weight: bold;
    color: #2c3e50;
}

.payment-stats {
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    margin-top: 20px;
}

.payment-stats h3 {
    margin: 0 0 15px 0;
    color: #2c3e50;
}

.payment-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 15px;
}

.payment-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px;
    background: #f8f9fa;
    border-radius: 4px;
}

.stats-loading {
    text-align: center;
    padding: 40px;
    font-size: 18px;
    color: #666;
}
 .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stat-card h3 {
            margin: 0 0 10px 0;
            font-size: 14px;
            color: #666;
            text-transform: uppercase;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
        }

        .payment-stats {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-top: 20px;
        }

        .payment-stats h3 {
            margin: 0 0 15px 0;
            color: #2c3e50;
        }

        .payment-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }

        .payment-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
        }

        .stats-loading {
            text-align: center;
            padding: 40px;
            font-size: 18px;
            color: #666;
        }

        .hidden {
            display: none;
        }
.no-animation {
  animation: none !important;
  transition: none !important;
}
/* Style sp√©cifique pour la vue d√©taill√©e dans le modal */
#invoiceManagerModal .preview-card.minimal {
  margin: 0;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  border: 1px solid #e0e0e0;
}

#invoiceManagerModal .invoice-header {
  border-bottom: 1px solid #e0e0e0;
  padding-bottom: 25px;
  margin-bottom: 25px;
}

#invoiceManagerModal .client-section {
  margin: 20px 0;
  padding: 15px;
  background: rgba(102, 126, 234, 0.05);
  border-left: 3px solid var(--primary);
}

#invoiceManagerModal .btn {
  font-size: 14px;
  padding: 8px 16px;
}
/* Ajouter dans la section CSS */
.status-badge {
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 12px;
  font-weight: bold;
  color: white;
}

.status-paid {
  background: #00b894;
}

.status-unpaid {
  background: #ff7675;
}
:root {
  --primary: #667eea;
  --primary-dark: #5568d3;
  --secondary: #764ba2;
  --accent: #67f2e9;
  --dark: #1a1a2e;
  --light: #f8f9fa;
  --text: #2d3436;
  --text-muted: #636e72;
  --success: #00b894;
  --danger: #ff7675;
  --warning: #fdcb6e;
  --panel-bg: #ffffff;
  --muted: #666;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

html, body {
  height: 100%;
  font-family: 'Poppins', system-ui, sans-serif;
  background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
  color: var(--text);
}

.wrapper {
  max-width: 1100px;
  margin: 28px auto;
  padding: 24px;
}

.card {
  background: var(--panel-bg);
  border-radius: 14px;
  padding: 20px;
  box-shadow: 0 12px 30px rgba(0,0,0,0.18);
  margin-bottom: 20px;
}

h1 {
  color: var(--primary);
  margin: 0 0 12px 0;
  font-size: 22px;
}

.grid {
  display: grid;
  grid-template-columns: 1fr;
  gap: 18px;
}

label {
  display: block;
  font-weight: 600;
  margin-bottom: 6px;
}

input, textarea, select {
  width: 50%;
  padding: 10px;
  border: 2px solid #eee;
  border-radius: 8px;
  font-size: 14px;
}

textarea {
  min-height: 70px;
}

.row {
  display: flex;
  gap: 12px;
}

.row > * {
  flex: 1;
}

.btn {
  background: var(--primary);
  color: #fff;
  padding: 10px 12px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-weight: 700;
  transition: all 0.3s ease;
}

.btn:hover {
  background: var(--primary-dark);
  transform: translateY(-1px);
}

.btn.small {
  padding: 8px 10px;
  font-size: 13px;
}

.btn.ghost {
  background: transparent;
  border: 2px solid #eee;
  color: #fff;
}

/* Items Section */
.items-section h3 {
  color: var(--primary);
  margin: 0 0 10px;
}

.item-row {
  display: grid;
  grid-template-columns: 2fr 70px 120px 70px 40px;
  gap: 8px;
  align-items: end;
  margin-bottom: 8px;
}

input.item-desc {
  width: 90%;
}


input.item-price {
  width: 90%;
}

input#invoiceNumber {
  width: 95%;
}

input#invoiceDate {
  width: 140px;
}

.adjustment-display {
  grid-column: 1/-1;
  background: #f8f9fa;
  padding: 8px;
  border-radius: 8px;
  margin-top: 6px;
}

.catalog-section {
  max-height: 360px;
  overflow: auto;
  background: #f7f8fb;
  padding: 8px;
  border-radius: 8px;
}

.catalog-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px;
  border-radius: 8px;
  background: #fff;
  margin-bottom: 8px;
  border: 1px solid #f0f0f0;
}
input.item-tax {
    WIDTH: 100%;
}
.catalog-item .meta {
  color: var(--muted);
  font-size: 13px;
}

/* Preview Styles */
.preview-container {
  margin-top: 30px;
  position: relative;
}

.preview-tabs {
  display: flex;
  gap: 12px;
  margin-bottom: -2px;
  position: relative;
  z-index: 10;
}

.preview-tab {
  background: rgba(255, 255, 255, 0.9);
  border: none;
  padding: 12px 24px;
  border-radius: 12px 12px 0 0;
  cursor: pointer;
  font-weight: 600;
  font-size: 14px;
  color: var(--text-muted);
  transition: all 0.3s ease;
}

.preview-tab:hover {
  background: rgba(255, 255, 255, 0.95);
  transform: translateY(-2px);
}

.preview-tab.active {
  background: white;
  color: var(--primary);
}

.preview-card {
  background: white;
  border-radius: 0px;
  padding: 40px;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
  position: relative;
  overflow: hidden;
  transition: all 0.4s ease;
}

.preview-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 6px;
  background: linear-gradient(90deg, var(--primary), var(--accent), var(--secondary));
}

/* Theme Variations */
.preview-card.classic {
  background: white;
}

.preview-card.classic .invoice-header {
  border-bottom: 3px solid var(--primary);
  padding-bottom: 20px;
  margin-bottom: 30px;
}

.preview-card.modern {
  background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
}

.preview-card.modern::before {
  height: 8px;
  background: linear-gradient(90deg, #667eea, #764ba2, #f093fb, #f5576c);
}

.preview-card.modern .invoice-header {
  background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
  padding: 24px;
  border-radius: 16px;
  margin-bottom: 30px;
}

.preview-card.dark {
  background: linear-gradient(145deg, #1f1f2e, #2b2b44);
  color: #f0f0f5;
}

.preview-card.dark::before {
  background: linear-gradient(90deg, var(--accent), var(--primary));
}

.preview-card.dark h2,
.preview-card.dark .section-title,
.preview-card.dark .invoice-number {
  color: #fff;
}

.preview-card.dark .muted {
  color: #a0a0b0;
}

.preview-card.dark .invoice-table {
  background: rgba(255, 255, 255, 0.05);
}

.preview-card.dark .invoice-table th {
  background: rgba(103, 242, 233, 0.2);
  color: #f0f0f5;
}

.preview-card.dark .invoice-table td {
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
  color: #f0f0f5;
}

.preview-card.minimal {
  background: white;
  padding: 50px;
}

.preview-card.minimal::before {
  height: 2px;
  background: var(--text);
}

.preview-card.minimal .invoice-header {
  border-bottom: 1px solid #e0e0e0;
  padding-bottom: 30px;
  margin-bottom: 40px;
}

.preview-card.minimal h2,
.preview-card.minimal .invoice-number {
  color: var(--text);
}

/* Invoice Elements */
.invoice-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  gap: 30px;
}

.company-info h2 {
  font-size: 28px;
  font-weight: 700;
  color: var(--primary);
  margin-bottom: 8px;
}

.company-address {
  color: var(--text-muted);
  font-size: 14px;
  line-height: 1.6;
}

.invoice-meta {
  text-align: right;
}

.invoice-number {
  font-size: 24px;
  font-weight: 700;
  color: var(--primary);
  margin-bottom: 8px;
}

.invoice-date {
  color: var(--text-muted);
  font-size: 14px;
}

.client-section {
  margin: 30px 0;
  padding: 20px;
  background: rgba(102, 126, 234, 0.05);
  border-radius: 12px;
  border-left: 4px solid var(--primary);
}

.section-title {
  font-weight: 700;
  color: var(--primary);
  font-size: 12px;
  letter-spacing: 1px;
  text-transform: uppercase;
  margin-bottom: 8px;
}

.client-name {
  font-weight: 600;
  font-size: 16px;
  color: #5568d3;
  margin-bottom: 4px;
}

.client-address {
  color: var(--text-muted);
  font-size: 14px;
  line-height: 1.6;
}

.invoice-table {
  width: 100%;
  border-collapse: separate;
  border-spacing: 0;
  margin: 30px 0;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
}

.invoice-table th {
  background: var(--primary);
  color: white;
  padding: 14px 16px;
  text-align: left;
  font-weight: 600;
  font-size: 13px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.invoice-table td {
  padding: 14px 16px;
  border-bottom: 1px solid #f0f0f0;
  font-size: 14px;
  text-align: left;
}

.invoice-table tbody tr {
  transition: all 0.3s ease;
}

.invoice-table tbody tr:hover {
  background: rgba(102, 126, 234, 0.03);
}

.text-right {
  text-align: right;
}

.totals {
  margin-left: auto;
  width: 50%;
  margin-top: 30px;
  padding: 24px;
  background: linear-gradient(135deg, rgba(102, 126, 234, 0.05), rgba(118, 75, 162, 0.05));
  border-radius: 20px;
  text-align: left;
}

.totals-row {
  display: flex;
  justify-content: flex-end;
  gap: 40px;
  padding: 8px 0;
  font-size: 15px;
}

.totals-label {
  font-weight: 600;
  color: var(--text-muted);
}

.totals-value {
  font-weight: 700;
  color: var(--primary);
  min-width: 150px;
  text-align: right;
}

.grand-total {
  margin-top: 12px;
  padding-top: 12px;
  border-top: 2px solid var(--primary);
}

.grand-total .totals-label,
.grand-total .totals-value {
  font-size: 20px;
  color: var(--primary);
}

.export-row {
  display: flex;
  gap: 12px;
  margin-top: 24px;
  flex-wrap: wrap;
}

.btn.secondary {
  background: var(--success);
}

.btn.outline {
  background: white;
  color: var(--primary);
  border: 2px solid var(--primary);
}

.btn.outline:hover {
  background: var(--primary);
  color: white;
}

/* Modal Styles */
.modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.7);
  z-index: 1000;
  align-items: center;
  justify-content: center;
}

.modal.active {
  display: flex;
}

.modal-content {
  width: 40%;
  background: white;
  border-radius: 14px;
  padding: 20px;
  max-height: 90vh;
  overflow-y: auto;
}

/* PDF Export Styles */


.pdf-invoice {
  width: 100%;
  background: white;
  color: black;
}



.pdf-company h2 {
  color: #667eea;
  margin: 10px;
  font-size: 24px;
}

.pdf-meta {
  text-align: right;
}

.pdf-number {
  font-size: 20px;
  font-weight: bold;
  color: #667eea;
  margin-bottom: 5px;
  margin-left: 200px;
}

.pdf-client {
  margin: 20px 0;
  padding: 15px;
  background: #f8f9fa;
  border-left: 4px solid #667eea;
}



.pdf-table th {
  background: #667eea;
  color: white;
  padding: 12px;
  text-align: center;
  border: 1px solid #5568d3;
}

.pdf-table td {
  text-align: center;
  padding: 12px;
  border: 1px solid #ddd;
}

.pdf-totals {
  margin-top: 30px;
  text-align: right;
  padding: 20px;
  background: #f8f9fa;
}



.pdf-grand-total {
  border-top: 2px solid #667eea;
  margin-top: 10px;
  padding-top: 10px;
  font-weight: bold;
  font-size: 18px;
  color: #667eea;
}

/* Utility Classes */
.muted {
  color: var(--muted);
  font-size: 13px;
}

.print-header {
  display: none;
  background: #f7f8fb;
  border-radius: 8px;
  padding: 12px;
  margin-bottom: 10px;
}

/* Responsive */
@media (max-width: 900px) {
  .item-row {
    grid-template-columns: 1fr;
  }
  
  .row {
    flex-direction: column;
  }
  
  .invoice-header {
    flex-direction: column;
    gap: 20px;
  }
  
  .invoice-meta {
    text-align: left;
  }
  
  .preview-card {
    padding: 24px;
  }
  
  .totals {
    width: 100%;
  }
  
  .totals-row {
    flex-direction: column;
    gap: 8px;
    text-align: left;
  }
  
  .totals-value {
    text-align: left;
  }
  
  .export-row {
    flex-direction: column;
  }
  
  input, textarea, select {
    width: 100%;
  }
  
  .modal-content {
    width: 90%;
  }
}

@media print {
  body {
    background: white;
  }
  
  .card, .preview-card {
    box-shadow: none;
  }
  
  .btn, .export-row, .btn-catalog, .preview-tabs {
    display: none !important;
  }
  
  .wrapper {
    max-width: 800px;
    margin: 0 auto;
    padding: 0;
  }
  
  .print-header {
    display: block;
    margin-bottom: 10px;
  }
}

/* Animations */
@keyframes fadeIn {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.preview-card {
  animation: fadeIn 0.5s ease;
}
</style>
</head>
<body>
  <div class="wrapper">
    <div class="card">
      <h1>üìÑ G√©n√©rateur de Facture</h1>
      <div class="grid">
        <div>
          <label for="companySelect">Soci√©t√©</label>
          <div style="display:flex;gap:10px">
            <select id="companySelect"></select>
            <button class="btn small" onclick="openCompanyForm()">üë• G√©rer</button>
          </div>
        </div>

        <div style="display:flex;gap:12px;margin-top:8px">
          <div style="flex:1">
            <label>Num√©ro de facture</label>
            <input id="invoiceNumber" placeholder="INV-2025-001">
          </div>
          <div style="margin-right:10%;width:200px">
            <label>Date</label>
            <input type="date" id="invoiceDate">
          </div>
        </div>

        <div style="margin-top:8px">
          <label>Client</label>
          <div style="display:flex;gap:10px">
            <select id="clientSelect" style="flex:1"></select>
            <button class="btn small" onclick="openClientList()">üë• G√©rer</button>
          </div>
        </div>

        <div class="items-section card" style="margin-top:6px">
          <h3>Articles / Services</h3>
          <div style="display:flex;gap:10px">
            <button class="btn" onclick="openCatalog()">üì¶ Choisir depuis le catalogue</button>
            <button class="btn small" onclick="addItem()">+ Ajouter un article</button>
          </div>

          <div id="itemsContainer" style="margin-top:12px">
            <div class="item-row">
              <input class="item-desc" placeholder="Nom + Dosage (ex: ENGYMYCINE 200 ML)">
              <input class="item-qty" type="number" min="1" value="1">
              <input class="item-price" type="number" step="0.01" min="0" data-base-price="0">
              <input class="item-tax" type="number" min="0" max="100" value="0">
              <button onclick="removeItem(this)">√ó</button>
              <div class="adjustment-display">
                <div style="display:flex;gap:6px;flex-wrap:wrap">
                  <button onclick="adjustPrice(this,-30)">-30%</button>
                  <button onclick="adjustPrice(this,-20)">-20%</button>
                  <button onclick="adjustPrice(this,-10)">-10%</button>
                  <button onclick="adjustPrice(this,-5)">-5%</button>
                  <button onclick="adjustPrice(this,-3)">-3%</button>
                  <button onclick="adjustPrice(this,-2)">-2%</button>
                  <button onclick="adjustPrice(this,0)">0%</button>
                  <button onclick="adjustPrice(this,2)">+2%</button>
                  <button onclick="adjustPrice(this,3)">+3%</button>
                  <button onclick="adjustPrice(this,5)">+5%</button>
                  <button onclick="adjustPrice(this,10)">+10%</button>
                  <button onclick="adjustPrice(this,20)">+20%</button>
                  <button onclick="adjustPrice(this,30)">+30%</button>
                </div>
                <div style="margin-top:8px" class="muted">Ajustement: <span class="adjustment-value">0%</span> | Prix de base: <span class="base-price-value">0.00</span> DZD</div>
              </div>
            </div>
          </div>
        </div>

        <div style="margin-top:8px; display: flex; gap: 10px;">
  <button class="btn" onclick="saveInvoice()">üíæ Enregistrer la facture</button>
  <button class="btn" onclick="newInvoice()" style="background: #00b894;">‚ûï Nouvelle facture</button>
  <button class="btn" onclick="openInvoiceManager()" style="background: #764ba2;">üìã G√©rer les factures</button>
</div>
      </div>
    </div>

    <!-- Preview Section -->
    <div class="preview-container">
      <div class="preview-tabs">
        <button class="preview-tab active" onclick="changeTheme('classic')">üìã Classique</button>
        <button class="preview-tab" onclick="changeTheme('modern')">‚ú® Moderne</button>
        <button class="preview-tab" onclick="changeTheme('dark')">üåô Sombre</button>
        <button class="preview-tab" onclick="changeTheme('minimal')">‚ö° Minimal</button>
      </div>
      
      <div class="preview-card classic" id="invoice">
        <div class="invoice-header">
          <div class="company-info">
            <h2 id="previewCompanyName">Votre Entreprise</h2>
            <div class="company-address" id="previewCompanyAddress">
              123 Rue Example<br>
              Alger, 16000
            </div>
          </div>
          <div class="invoice-meta">
            <div class="invoice-number" id="previewInvoiceNumber">FACTURE N¬∞ 001</div>
            <div class="invoice-date">Date: <span id="previewDate">06/11/2025</span></div>
          </div>
        </div>

        <div class="client-section">
          <div class="section-title">Facturer √† :</div>
          <div class="client-name" id="previewClientName">Nom du Client</div>
          <div class="client-address" id="previewClientAddress">
            456 Avenue Client<br>
            Alger, 16000
          </div>
        </div>

        <table class="invoice-table">
          <thead>
            <tr>
              <th style="width:40%">Description</th>
              <th class="text-right" style="width:1%">Quantit√©</th>
              <th class="text-right" style="width:140px">Prix unitaire</th>
              <th class="text-right" style="width:1%">TVA</th>
              <th class="text-right" style="width:140px">Total HT</th>
            </tr>
          </thead>
          <tbody id="invoiceItems">
            <tr>
              <td>ENGYMYCINE 200 ML</td>
              <td class="text-right">2</td>
              <td class="text-right">5,000.00 DZD</td>
              <td class="text-right">19%</td>
              <td class="text-right">10,000.00 DZD</td>
            </tr>
          </tbody>
        </table>

        <div class="totals" id="totalsSection">
          <div class="totals-row">
            <div class="totals-label">Sous-total HT:</div>
            <div class="totals-value" id="subtotal">15,500.00 DZD</div>
          </div>
          <div class="totals-row">
            <div class="totals-label">TVA (19%):</div>
            <div class="totals-value" id="taxAmount">2,945.00 DZD</div>
          </div>
          <div class="totals-row grand-total">
            <div class="totals-label">TOTAL TTC:</div>
            <div class="totals-value" id="total">18,445.00 DZD</div>
          </div>
        </div>
      </div>

      <div class="export-row">
        <button class="btn" onclick="exportToPDF()">üìÑ Exporter PDF</button>
        <button class="btn" style="background:#555;" onclick="exportToTextPDF()">üìë Exporter PDF (Texte)</button>
        <button class="btn secondary" onclick="exportToWord()">üìù Exporter Word</button>
        <button class="btn outline" onclick="printInvoice()">üñ®Ô∏è Imprimer</button>
      </div>
    </div>
  </div>

  

  <!-- Modals -->
  <div class="modal" id="catalogModal">
    <div class="modal-content">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3 style="margin:0;color:var(--primary)">üì¶ Catalogue de produits</h3>
        <button onclick="closeCatalog()">√ó</button>
      </div>
      <div style="display:flex;gap:8px;margin-top:8px">
        <input id="productSearch" placeholder="Recherche..." oninput="renderCatalog()" style="flex:1">
        <button class="btn small" onclick="openAddProductForm()">+ Produit</button>
      </div>
      <div style="margin-top:8px">
	  <button onclick="exportCatalogToJSON()" class="btn small">Exporter (JSON)</button>
	  <button onclick="importCatalogFromJSON()" class="btn small" style="background: #00b894;">Importer (JSON)</button></div>
      <div class="catalog-section" id="catalogItems" style="margin-top:12px"></div>
    </div>
  </div>

  <div class="modal" id="companyModal">
    <div class="modal-content">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3 style="margin:0;color:var(--primary)">üè¢ G√©rer Soci√©t√©s</h3>
        <button onclick="closeCompanyForm()">√ó</button>
      </div>
      <div style="margin-top:8px"><button class="btn small" onclick="openAddCompanyForm()">+ Ajouter soci√©t√©</button></div>
      <div class="catalog-section" id="companyList" style="margin-top:12px"></div>
    </div>
  </div>

  <div class="modal" id="companyFormModal">
    <div class="modal-content">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3 id="companyFormTitle" style="margin:0;color:var(--primary)">Ajouter soci√©t√©</h3>
        <button onclick="closeCompanyEditForm()">√ó</button>
      </div>
      <div style="margin-top:8px">
        <div style="margin-bottom:8px"><label>Nom</label><input id="companyNameInput"></div>
        <div style="margin-bottom:8px"><label>Adresse</label><textarea id="companyAddressInput"></textarea></div>
        <div style="margin-bottom:8px"><label>T√©l√©phone</label><input id="companyPhoneInput"></div>
        <div style="margin-bottom:8px"><label>Email</label><input id="companyEmailInput"></div>
        <div style="margin-top:8px">
          <button class="btn" onclick="saveCompany()">üíæ Enregistrer</button>
          <button onclick="closeCompanyEditForm()">Annuler</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal" id="clientModal">
    <div class="modal-content">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3 style="margin:0;color:var(--primary)">üë• G√©rer Clients</h3>
        <button onclick="closeClientList()">√ó</button>
      </div>
      <div style="margin-top:8px"><button class="btn small" onclick="openAddClientForm()">+ Ajouter client</button></div>
      <div class="catalog-section" id="clientList" style="margin-top:12px"></div>
    </div>
  </div>

  <div class="modal" id="clientFormModal">
    <div class="modal-content">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3 id="clientFormTitle" style="margin:0;color:var(--primary)">Ajouter client</h3>
        <button onclick="closeClientForm()">√ó</button>
      </div>
      <div style="margin-top:8px">
        <div style="margin-bottom:8px"><label>Nom</label><input id="clientNameInput"></div>
        <div style="margin-bottom:8px"><label>Adresse</label><textarea id="clientAddressInput"></textarea></div>
        <div style="margin-bottom:8px"><label>T√©l√©phone</label><input id="clientPhoneInput"></div>
        <div style="margin-bottom:8px"><label>Email</label><input id="clientEmailInput"></div>
        <div style="margin-top:8px">
          <button class="btn" onclick="saveClient()">üíæ Enregistrer</button>
          <button onclick="closeClientForm()">Annuler</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal" id="productFormModal">
    <div class="modal-content">
        <div style="display:flex;justify-content:space-between;align-items:center">
            <h3 id="productFormTitle" style="margin:0;color:var(--primary)">Ajouter un produit</h3>
            <button onclick="closeProductForm()">√ó</button>
        </div>
        <div style="margin-top:8px">
            <div style="margin-bottom:8px">
                <label>Nom</label>
                <input type="text" id="productNameInput">
            </div>
            <div style="margin-bottom:8px">
                <label>Cat√©gorie</label>
                <input type="text" id="productCategoryInput">
            </div>
            <div style="margin-bottom:8px">
                <label>Prix</label>
                <input type="number" step="0.01" id="productPriceInput">
            </div>
            <div style="margin-bottom:8px">
                <label>Dosage</label>
                <input type="text" id="productDosageInput">
            </div>
            <div style="margin-bottom:8px">
                <label>Fabricant</label>
                <input type="text" id="productManufacturerInput">
            </div>
            <div style="margin-bottom:8px">
                <label>Prix d'origine</label>
                <input type="number" step="0.01" id="productOriginalPriceInput">
            </div>
            <div style="margin-bottom:8px">
    <label>Image du produit</label>
    <div style="display: flex; gap: 10px; align-items: center;">
        <input type="file" id="productImageUpload" accept="image/*" style="flex: 1;" onchange="handleImageUpload(this)">
        <button type="button" class="btn small" onclick="clearImage()" style="background: #ff7675;">√ó</button>
    </div>
    <div id="imagePreview" style="margin-top: 8px; display: none;">
        <img id="previewImage" style="max-width: 200px; max-height: 150px; border: 1px solid #ddd; border-radius: 4px;">
        <div style="margin-top: 5px;">
            <small id="imageSizeInfo" style="color: #666;"></small>
        </div>
    </div>
    <!-- Keep the hidden base64 field for storage -->
    <textarea id="productImageInput" style="display: none;"></textarea>
</div>
            <div style="margin-bottom:8px">
                <label>Stock</label>
                <input type="number" min="0" id="productStockInput" value="1">
            </div>
            <div style="margin-top:8px">
                <button class="btn" onclick="saveProduct()">üíæ Enregistrer</button>
                <button type="button" onclick="closeProductForm()">Annuler</button>
            </div>
        </div>
    </div>
</div>

  <div class="modal" id="invoiceManagerModal">
    <div class="modal-content" style="width:80%;max-height:90vh;overflow-y:auto">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3 style="margin:0;color:var(--primary)">üìã G√©rer les Factures</h3>
        <button onclick="closeInvoiceManager()">√ó</button>
      </div>
<div class="stats-section">
    <!-- Loading message -->
    <div class="stats-loading">
        Chargement des statistiques...
    </div>
    


      <div style="margin-top:15px;display:flex;gap:10px;align-items:center">
        <input id="invoiceSearch" placeholder="Rechercher une facture..." style="flex:1">
        <button class="btn small" onclick="filterInvoices()">üîç Rechercher</button>
        <button class="btn small" onclick="loadInvoices()">üîÑ Actualiser</button>
      </div>

      <div style="margin-top:10px;display:flex;gap:10px;align-items:center">
        <label style="font-size:14px;margin:0">Filtrer par statut:</label>
        <select id="statusFilter" onchange="filterInvoices()" style="width:auto;padding:5px 10px">
          <option value="all">Toutes les factures</option>
          <option value="paid">Pay√©es</option>
          <option value="unpaid">Impay√©es</option>
        </select>
      </div>
      
      <div style="margin-top:15px;display:flex;gap:15px">
        <div style="flex:1">
          <h4 style="margin-bottom:10px;color:var(--primary)">Liste des Factures</h4>
          <div class="catalog-section" id="invoiceList" style="max-height:400px"></div>
        </div>
        
        <div style="flex:1">
          <h4 style="margin-bottom:10px;color:var(--primary)">Dettes des Clients</h4>
          <div class="catalog-section" id="clientDebts" style="max-height:400px"></div>
        </div>
      </div>
      
      <div id="invoiceDetail" style="margin-top:20px;display:none">
  <div class="preview-card minimal" style="padding:30px; margin-top:15px;">
    <div class="invoice-header">
      <div class="company-info">
        <h2 id="detailCompanyName">Soci√©t√©</h2>
        <div class="company-address" id="detailCompanyAddress">
          Adresse de la soci√©t√©
        </div>
      </div>
      <div class="invoice-meta">
        <div class="invoice-number" id="detailInvoiceNumber">FACTURE N¬∞ ---</div>
        <div class="invoice-date">Date: <span id="detailInvoiceDate">--/--/----</span></div>
      </div>
    </div>

    <div class="client-section">
      <div class="section-title">Facturer √† :</div>
      <div class="client-name" id="detailClientName">Nom du Client</div>
      <div class="client-address" id="detailClientAddress">
        Adresse du client
      </div>
    </div>

    <table class="invoice-table">
      <thead>
        <tr>
          <th style="width:40%">Description</th>
          <th class="text-right" style="width:1%">Quantit√©</th>
          <th class="text-right" style="width:140px">Prix unitaire</th>
          <th class="text-right" style="width:1%">TVA</th>
          <th class="text-right" style="width:140px">Total HT</th>
        </tr>
      </thead>
      <tbody id="detailInvoiceItems">
        <!-- Les articles seront ins√©r√©s ici dynamiquement -->
      </tbody>
    </table>

    <div class="totals" id="detailTotalsSection">
      <div class="totals-row">
        <div class="totals-label">Sous-total HT:</div>
        <div class="totals-value" id="detailSubtotal">0.00 DZD</div>
      </div>
      <div class="totals-row">
        <div class="totals-label">TVA:</div>
        <div class="totals-value" id="detailTaxAmount">0.00 DZD</div>
      </div>
      <div class="totals-row grand-total">
        <div class="totals-label">TOTAL TTC:</div>
        <div class="totals-value" id="detailTotal">0.00 DZD</div>
      </div>
    </div>

    <div style="margin-top:25px; display:flex; gap:10px; flex-wrap:wrap;">
      <button class="btn" onclick="editSelectedInvoice()">‚úèÔ∏è Modifier</button>
      <button class="btn" style="background:#ff7675" onclick="deleteSelectedInvoice()">üóëÔ∏è Supprimer</button>
      <button class="btn" style="background:#00b894" onclick="markInvoiceAsPaid()">‚úÖ Marquer comme pay√©e</button>
      <button class="btn" onclick="exportInvoiceDetailToPDF()">üìÑ Exporter PDF</button>
	  <button class="btn outline" onclick="printInvoiceDetail()">üñ®Ô∏è Imprimer</button>
    </div>
  </div>
</div>
    <!-- Statistics content (initially hidden) -->
    <div class="stats-container">
                
        <div class="stats-content hidden">
            <h2>üìä Tableau de Bord</h2>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>Total Factures</h3>
                    <div class="stat-value stat-total-invoices">0</div>
                </div>
                
                <div class="stat-card">
                    <h3>Total Clients</h3>
                    <div class="stat-value stat-total-clients">0</div>
                </div>
                
                <div class="stat-card">
                    <h3>Total Soci√©t√©s</h3>
                    <div class="stat-value stat-total-companies">0</div>
                </div>
                
                <div class="stat-card">
                    <h3>Chiffre d'Affaires</h3>
                    <div class="stat-value stat-total-revenue">0 da</div>
                </div>
                
                <div class="stat-card">
                    <h3>Factures Pay√©es</h3>
                    <div class="stat-value stat-paid-invoices">0</div>
                </div>
                
                <div class="stat-card">
                    <h3>Factures Impay√©es</h3>
                    <div class="stat-value stat-unpaid-invoices">0</div>
                </div>
                
                <div class="stat-card">
                    <h3>Factures R√©centes (30j)</h3>
                    <div class="stat-value stat-recent-invoices">0</div>
                </div>
            </div>
            
            <div class="payment-stats">
                <h3>Statistiques de Paiement</h3>
                <div class="payment-grid">
                    <div class="payment-item">
                        <span>Taux de Paiement:</span>
                        <strong class="stat-paid-percentage">0%</strong>
                    </div>
                    <div class="payment-item">
                        <span>Montant Pay√©:</span>
                        <strong class="stat-paid-amount">0 da</strong>
                    </div>
                    <div class="payment-item">
                        <span>Montant En Attente:</span>
                        <strong class="stat-unpaid-amount">0 da</strong>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>
  </div>

<script>
// OVERRIDE - Add this at the very top of your script
window.saveProduct = async function() {
    console.log("üîÑ OVERRIDE saveProduct working!");
    
    const name = document.getElementById('productNameInput').value.trim();
    const category = document.getElementById('productCategoryInput').value.trim();
    const price = parseFloat(document.getElementById('productPriceInput').value) || 0;
    const dosage = document.getElementById('productDosageInput').value.trim();
    const manufacturer = document.getElementById('productManufacturerInput').value.trim();
    const originalPrice = parseFloat(document.getElementById('productOriginalPriceInput').value) || 0;
    const image = document.getElementById('productImageInput').value.trim();
    const stock = parseInt(document.getElementById('productStockInput').value) || 1;

    if (!name) {
        alert("Veuillez entrer un nom de produit");
        return;
    }

    const productData = { name, category, price, dosage, manufacturer, originalPrice, image, stock };

    try {
        const url = editingProductId ? `/api/medicines/${editingProductId}` : '/api/medicines';
        const method = editingProductId ? 'PUT' : 'POST';
        
        const response = await fetch(url, {
            method: method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(productData)
        });
        
        if (!response.ok) throw new Error('Save failed');
        
        await response.json();
        alert('Succ√®s!');
        closeProductForm();
        await loadCatalog();
        
    } catch (error) {
        alert('Erreur: ' + error.message);
    }
};
function debugFormElements() {
    const elements = [
        'productNameInput',
        'productCategoryInput', 
        'productPriceInput',
        'productDosageInput',
        'productManufacturerInput',
        'productOriginalPriceInput',
        'productImageInput',
        'productStockInput'
    ];
    
    elements.forEach(id => {
        const element = document.getElementById(id);
        console.log(`${id}:`, element ? 'EXISTS' : 'MISSING');
    });
}

// Call this in the console to check
debugFormElements();
        // Statistics functionality
        class Statistics {
            static async loadStats() {
                try {
                    console.log("üìä Loading statistics...");
                    
                    // Load overview stats
                    const overviewResponse = await fetch('/api/stats/overview');
                    if (!overviewResponse.ok) throw new Error('Failed to fetch overview');
                    const overviewData = await overviewResponse.json();
                    
                    // Load payment stats
                    const paymentResponse = await fetch('/api/stats/payment-stats');
                    if (!paymentResponse.ok) throw new Error('Failed to fetch payment stats');
                    const paymentData = await paymentResponse.json();
                    
                    // Update the UI with the data
                    this.updateStatsUI(overviewData, paymentData);
                    
                } catch (error) {
                    console.error('Error loading statistics:', error);
                    this.showError('Erreur lors du chargement des statistiques');
                }
            }
            
            static updateStatsUI(overview, payments) {
                console.log("Updating UI with stats:", overview);
                
                // Update overview cards
                this.updateElement('.stat-total-invoices', overview.total_invoices);
                this.updateElement('.stat-total-clients', overview.total_clients);
                this.updateElement('.stat-total-companies', overview.total_companies);
                this.updateElement('.stat-total-revenue', `${overview.total_revenue.toLocaleString()} da`);
                this.updateElement('.stat-paid-invoices', overview.paid_invoices);
                this.updateElement('.stat-unpaid-invoices', overview.unpaid_invoices);
                this.updateElement('.stat-recent-invoices', overview.recent_invoices);
                
                // Update payment stats
                this.updateElement('.stat-paid-percentage', `${payments.paid_percentage}%`);
                this.updateElement('.stat-paid-amount', `${payments.paid_amount.toLocaleString()} da`);
                this.updateElement('.stat-unpaid-amount', `${payments.unpaid_amount.toLocaleString()} da`);
                
                // Hide loading message and show stats
                document.querySelector('.stats-loading').classList.add('hidden');
                document.querySelector('.stats-content').classList.remove('hidden');
            }
            
            static updateElement(selector, value) {
                const element = document.querySelector(selector);
                if (element) {
                    element.textContent = value;
                }
            }
            
            static showError(message) {
                const loadingElement = document.querySelector('.stats-loading');
                if (loadingElement) {
                    loadingElement.innerHTML = `<div style="color: red; padding: 10px;">${message}</div>`;
                }
            }
        }

        // Initialize stats when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Load stats immediately
            Statistics.loadStats();
            
            // Refresh stats every 30 seconds
            setInterval(() => {
                Statistics.loadStats();
            }, 30000);
        });

        // Test function for debugging
        window.testStats = function() {
            console.log('Manual stats refresh...');
            Statistics.loadStats();
        };

async function loadInvoiceStats() {
  try {
    const response = await fetch('/api/invoices/stats');
    if (response.ok) {
      const stats = await response.json();
      
      // Afficher les stats dans l'interface (optionnel)
      const statsElement = document.getElementById('invoiceStats');
      if (statsElement) {
        statsElement.innerHTML = `
          <div style="display: flex; gap: 15px; flex-wrap: wrap; margin: 10px 0;">
            <div style="background: #667eea; color: white; padding: 10px; border-radius: 8px;">
              <strong>Total: ${stats.total_invoices}</strong>
            </div>
            <div style="background: #00b894; color: white; padding: 10px; border-radius: 8px;">
              <strong>Pay√©es: ${stats.paid_invoices}</strong>
            </div>
            <div style="background: #ff7675; color: white; padding: 10px; border-radius: 8px;">
              <strong>Impay√©es: ${stats.unpaid_invoices}</strong>
            </div>
            <div style="background: #fdcb6e; color: black; padding: 10px; border-radius: 8px;">
              <strong>Dettes: ${(stats.unpaid_amount || 0).toFixed(2)} DZD</strong>
            </div>
          </div>
        `;
      }
      
      return stats;
    }
  } catch (error) {
    console.error('Error loading stats:', error);
  }
}

// Appeler cette fonction dans openInvoiceManager()
function openInvoiceManager() {
  loadInvoices();
  loadClientDebts();
  loadInvoiceStats(); // ‚Üê Ajoutez cette ligne
  qs('#invoiceManagerModal').classList.add('active');
}
// Utility functions
const qs = (s, p = document) => p.querySelector(s);
const qsa = (s, p = document) => Array.from(p.querySelectorAll(s));

// Global variables
let catalog = [];
let filteredCatalog = [];
let currentSelectedInvoiceId = null;
let editingProductId = null;

// Initialize on load
document.addEventListener('DOMContentLoaded', () => {
  document.getElementById('invoiceDate').valueAsDate = new Date();
  qs('.item-desc').placeholder = 'Nom + Dosage (ex: ENGYMYCINE 200 ML)';
  loadCatalog();
  loadCompanies();
  loadClients();
  generateInvoice();
});

// Company management
async function loadCompanies() {
  try {
    const res = await fetch('/api/companies');
    const list = res.ok ? await res.json() : [];
    const sel = qs('#companySelect');
    sel.innerHTML = '';
    
    list.forEach(c => {
      const o = document.createElement('option');
      o.value = c.id;
      o.textContent = c.name || ('Soci√©t√© ' + c.id);
      o.dataset.address = c.address || '';
      o.dataset.phone = c.phone || '';
      o.dataset.email = c.email || '';
      sel.appendChild(o);
    });
    
    if (sel.options.length) sel.value = sel.options[0].value;
    updateCompanyPreview();
    renderCompanyList();
  } catch (e) {
    console.error(e);
  }
}

function updateCompanyPreview() {
  const sel = qs('#companySelect');
  const opt = sel.options[sel.selectedIndex];
  if (!opt) return;
  
  qs('#previewCompanyName').textContent = opt.textContent;
  qs('#previewCompanyAddress').innerHTML = (opt.dataset.address || '').replace(/\n/g, '<br>');
}

function openCompanyForm() {
  qs('#companyModal').classList.add('active');
}

function closeCompanyForm() {
  qs('#companyModal').classList.remove('active');
}

function openAddCompanyForm() {
  qs('#companyFormTitle').textContent = 'Ajouter soci√©t√©';
  qs('#companyNameInput').value = '';
  qs('#companyAddressInput').value = '';
  qs('#companyPhoneInput').value = '';
  qs('#companyEmailInput').value = '';
  qs('#companyFormModal').classList.add('active');
}

function closeCompanyEditForm() {
  qs('#companyFormModal').classList.remove('active');
}

function renderCompanyList() {
  fetch('/api/companies').then(r => r.ok ? r.json() : []).then(list => {
    const wrap = qs('#companyList');
    wrap.innerHTML = '';
    
    list.forEach(c => {
      const div = document.createElement('div');
      div.style.display = 'flex';
      div.style.justifyContent = 'space-between';
      div.style.alignItems = 'center';
      div.style.padding = '8px';
      div.style.borderBottom = '1px solid #eee';
      
      div.innerHTML = `
        <div>
          <strong>${c.name || '(Sans nom)'}</strong>
          <div style="font-size:12px;color:#666">${(c.address || '').split('\n').slice(0, 2).join(', ')}</div>
        </div>
        <div>
          <button onclick="editCompany(${c.id})">‚úèÔ∏è</button>
          <button onclick="deleteCompany(${c.id})">üóëÔ∏è</button>
        </div>
      `;
      
      wrap.appendChild(div);
    });
  }).catch(() => {});
}

function editCompany(id) {
  fetch('/api/companies/' + id).then(r => r.json()).then(c => {
    qs('#companyFormTitle').textContent = 'Modifier soci√©t√©';
    qs('#companyNameInput').value = c.name || '';
    qs('#companyAddressInput').value = c.address || '';
    qs('#companyPhoneInput').value = c.phone || '';
    qs('#companyEmailInput').value = c.email || '';
    qs('#companyFormModal').classList.add('active');
  }).catch(() => alert('Impossible de charger la soci√©t√©'));
}

async function saveCompany() {
  const name = qs('#companyNameInput').value.trim();
  const address = qs('#companyAddressInput').value.trim();
  const phone = qs('#companyPhoneInput').value.trim();
  const email = qs('#companyEmailInput').value.trim();
  
  if (!name) return alert('Entrez le nom de la soci√©t√©');
  
  await fetch('/api/companies', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ name, address, phone, email })
  });
  
  closeCompanyEditForm();
  loadCompanies();
}

async function deleteCompany(id) {
  if (!confirm('Supprimer la soci√©t√© ?')) return;
  await fetch('/api/companies/' + id, { method: 'DELETE' });
  loadCompanies();
}

// Client management
async function loadClients() {
  try {
    const res = await fetch('/api/clients');
    const list = res.ok ? await res.json() : [];
    const sel = qs('#clientSelect');
    sel.innerHTML = '';
    
    list.forEach(c => {
      const o = document.createElement('option');
      o.value = c.id;
      o.textContent = c.name || ('Client ' + c.id);
      o.dataset.address = c.address || '';
      sel.appendChild(o);
    });
    
    if (sel.options.length) sel.value = sel.options[0].value;
    updateClientPreview();
  } catch (e) {
    console.error(e);
  }
}

function updateClientPreview() {
  const sel = qs('#clientSelect');
  const opt = sel.options[sel.selectedIndex];
  if (!opt) return;
  
  qs('#previewClientName').textContent = opt.textContent;
  qs('#previewClientAddress').innerHTML = (opt.dataset.address || '').replace(/\n/g, '<br>');
}

function openClientList() {
  renderClientList();
  qs('#clientModal').classList.add('active');
}

function closeClientList() {
  qs('#clientModal').classList.remove('active');
}

function openAddClientForm() {
  qs('#clientFormTitle').textContent = 'Ajouter client';
  qs('#clientNameInput').value = '';
  qs('#clientAddressInput').value = '';
  qs('#clientPhoneInput').value = '';
  qs('#clientEmailInput').value = '';
  qs('#clientFormModal').classList.add('active');
}

function closeClientForm() {
  qs('#clientFormModal').classList.remove('active');
}

function closeProductForm() {
    const modal = document.getElementById('productFormModal');
    if (modal) {
        modal.classList.remove('active');
    }
    editingProductId = null;
    
    // Clear the form
    document.getElementById('productNameInput').value = '';
    document.getElementById('productCategoryInput').value = '';
    document.getElementById('productPriceInput').value = '';
    document.getElementById('productDosageInput').value = '';
    document.getElementById('productManufacturerInput').value = '';
    document.getElementById('productOriginalPriceInput').value = '';
    document.getElementById('productImageInput').value = '';
    document.getElementById('productStockInput').value = '1';
}

function renderClientList() {
  fetch('/api/clients').then(r => r.ok ? r.json() : []).then(list => {
    const wrap = qs('#clientList');
    wrap.innerHTML = '';
    
    list.forEach(c => {
      const div = document.createElement('div');
      div.style.display = 'flex';
      div.style.justifyContent = 'space-between';
      div.style.alignItems = 'center';
      div.style.padding = '8px';
      div.style.borderBottom = '1px solid #eee';
      
      div.innerHTML = `
        <div>
          <strong>${c.name || '(Sans nom)'}</strong>
          <div style="font-size:12px;color:#666">${(c.address || '').split('\n').slice(0, 2).join(', ')}</div>
        </div>
        <div>
          <button onclick="editClient(${c.id})">‚úèÔ∏è</button>
          <button onclick="deleteClient(${c.id})">üóëÔ∏è</button>
        </div>
      `;
      
      wrap.appendChild(div);
    });
  }).catch(() => {});
}

function editClient(id) {
  fetch('/api/clients/' + id).then(r => r.json()).then(c => {
    qs('#clientFormTitle').textContent = 'Modifier client';
    qs('#clientNameInput').value = c.name || '';
    qs('#clientAddressInput').value = c.address || '';
    qs('#clientPhoneInput').value = c.phone || '';
    qs('#clientEmailInput').value = c.email || '';
    qs('#clientFormModal').classList.add('active');
  }).catch(() => alert('Impossible de charger le client'));
}

async function deleteClient(id) {
  if (!confirm('Supprimer le client ?')) return;
  await fetch('/api/clients/' + id, { method: 'DELETE' });
  loadClients();
  renderClientList();
}

async function saveClient() {
  const name = qs('#clientNameInput').value.trim();
  const address = qs('#clientAddressInput').value.trim();
  const phone = qs('#clientPhoneInput').value.trim();
  const email = qs('#clientEmailInput').value.trim();
  
  if (!name) return alert('Entrez le nom du client');
  
  await fetch('/api/clients', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ name, address, phone, email })
  });
  
  closeClientForm();
  loadClients();
  renderClientList();
}

// Catalog management - Updated to use backend API (NO TAX)
async function loadCatalog() {
  try {
    const res = await fetch('/api/medicines');
    if (!res.ok) throw new Error('Failed to load medicines');
    
    const data = await res.json();
    catalog = data.map(p => ({
      id: p.id,
      name: p.name || '',
      category: p.category || '',
      price: parseFloat(p.price) || 0,
      dosage: p.dosage || '',
      manufacturer: p.manufacturer || '',
      originalPrice: parseFloat(p.originalPrice) || 0,
      image: p.image || '',
      stock: parseInt(p.stock) || 0
      // TAX FIELD REMOVED
    }));
    
    renderCatalog();
  } catch (e) {
    console.error('Error loading medicines:', e);
    qs('#catalogItems').innerHTML = '<div style="padding:12px;color:#999">Impossible de charger les m√©dicaments</div>';
  }
}

// Updated saveProduct function (NO TAX)
async function saveProduct() {
    console.log("üîÑ saveProduct() called");
    
    try {
        // Get form values safely
        const name = document.getElementById('productNameInput').value.trim();
        const category = document.getElementById('productCategoryInput').value.trim();
        const price = parseFloat(document.getElementById('productPriceInput').value) || 0;
        const dosage = document.getElementById('productDosageInput').value.trim();
        const manufacturer = document.getElementById('productManufacturerInput').value.trim();
        const originalPrice = parseFloat(document.getElementById('productOriginalPriceInput').value) || 0;
        const image = document.getElementById('productImageInput').value.trim();
        const stock = parseInt(document.getElementById('productStockInput').value) || 1;

        console.log("‚úÖ Successfully retrieved all form values");

        // Validation
        if (!name) {
            alert("Veuillez entrer un nom de produit");
            return;
        }

        // Prepare data
        const productData = {
            name,
            category,
            price,
            dosage,
            manufacturer,
            originalPrice,
            image,
            stock
        };

        console.log("üì¶ Product data to save:", productData);

        // Determine if we're creating or updating
        const url = editingProductId ? `/api/medicines/${editingProductId}` : '/api/medicines';
        const method = editingProductId ? 'PUT' : 'POST';

        // Send to server
        const response = await fetch(url, {
            method: method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(productData)
        });

        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`Server error ${response.status}: ${errorText}`);
        }

        const result = await response.json();
        console.log("‚úÖ Save successful:", result);

        // Show success message
        alert(editingProductId ? 'Produit mis √† jour avec succ√®s!' : 'Produit ajout√© avec succ√®s!');

        // Close form and refresh catalog
        closeProductForm();
        await loadCatalog();
        renderCatalog();

    } catch (error) {
        console.error('‚ùå Error saving product:', error);
        alert('Erreur lors de la sauvegarde: ' + error.message);
    }
}
// Update renderCatalog to remove tax display
function renderCatalog() {
    const wrap = qs('#catalogItems');
    wrap.innerHTML = '';
    const query = (qs('#productSearch')?.value || '').toLowerCase();

    filteredCatalog = catalog.filter(p => 
        p.name.toLowerCase().includes(query) ||
        (p.category && p.category.toLowerCase().includes(query)) ||
        (p.manufacturer && p.manufacturer.toLowerCase().includes(query))
    );

    if (!filteredCatalog.length) {
        wrap.innerHTML = '<div style="padding:12px;color:#999;text-align:center">Aucun produit trouv√©</div>';
        return;
    }

    filteredCatalog.forEach((p, idx) => {
        const div = document.createElement('div');
        div.className = 'catalog-item';
        
        // Enhanced stock indicator with colors and warnings
        let stockColor = '#00b894';
        let stockBgColor = '#f8fff9';
        let stockText = `${p.stock} unit√©s`;
        let stockIcon = 'üì¶';
        let stockWarning = '';
        
        if (p.stock <= 0) {
            stockColor = '#ff7675';
            stockBgColor = '#fff5f5';
            stockText = '√âpuis√©';
            stockIcon = '‚ùå';
            stockWarning = ' (Commander urgent!)';
        } else if (p.stock <= 5) {
            stockColor = '#ff7675';
            stockBgColor = '#fff5f5';
            stockText = `${p.stock} unit√©s`;
            stockIcon = '‚ö†Ô∏è';
            stockWarning = ' (Stock critique)';
        } else if (p.stock <= 10) {
            stockColor = '#fdcb6e';
            stockBgColor = '#fffbf0';
            stockText = `${p.stock} unit√©s`;
            stockIcon = '‚ö†Ô∏è';
            stockWarning = ' (Stock faible)';
        } else if (p.stock <= 20) {
            stockColor = '#74b9ff';
            stockBgColor = '#f0f8ff';
            stockText = `${p.stock} unit√©s`;
            stockIcon = 'üì¶';
            stockWarning = ' (Stock moyen)';
        } else {
            stockColor = '#00b894';
            stockBgColor = '#f8fff9';
            stockText = `${p.stock} unit√©s`;
            stockIcon = 'üì¶';
            stockWarning = ' (Stock bon)';
        }
        
        div.innerHTML = `
            <div style="cursor:pointer; flex: 1;" onclick="selectCatalogItem(${idx})">
                <div style="font-weight:700; margin-bottom: 4px;">${p.name}</div>
                <div class="meta" style="margin-bottom: 4px;">
                    ${p.category ? `Cat√©gorie: ${p.category} | ` : ''}
                    Prix: ${p.price.toFixed(2)} DZD
                    ${p.originalPrice ? ` | Prix d'origine: ${p.originalPrice.toFixed(2)} DZD` : ''}
                </div>
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                    <span style="background: ${stockBgColor}; color: ${stockColor}; padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: bold; border: 1px solid ${stockColor}20;">
                        ${stockIcon} ${stockText}${stockWarning}
                    </span>
                </div>
                ${p.manufacturer ? `<div class="meta">Fabricant: ${p.manufacturer}</div>` : ''}
                ${p.dosage ? `<div class="meta">Dosage: ${p.dosage}</div>` : ''}
                ${p.originalPrice && p.originalPrice > p.price ? 
                    `<div class="meta" style="color: #00b894; font-weight: bold;">
                        üî• Promotion: ${((1 - p.price/p.originalPrice) * 100).toFixed(0)}% de r√©duction
                    </div>` : ''}
            </div>
            <div style="display: flex; gap: 5px;">
                <button onclick="openEditProductForm(event, ${p.id})">‚úèÔ∏è</button>
                <button onclick="deleteProduct(${p.id})" style="background: #ff7675; color: white;">üóëÔ∏è</button>
            </div>
        `;
        wrap.appendChild(div);
    });
}

// Add search functionality
function searchProducts() {
    renderCatalog();
}

// Update the search input event listener
document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('invoiceDate').valueAsDate = new Date();
    qs('.item-desc').placeholder = 'Nom + Dosage (ex: ENGYMYCINE 200 ML)';
    loadCatalog();
    loadCompanies();
    loadClients();
    generateInvoice();
    
    // Add search functionality
    const searchInput = document.getElementById('productSearch');
    if (searchInput) {
        searchInput.addEventListener('input', searchProducts);
    }
});

// Catalog management functions
function openCatalog() {
  loadCatalog();
  qs('#catalogModal').classList.add('active');
}

// Add this function to handle product deletion
async function deleteProduct(id) {
    if (!confirm('√ätes-vous s√ªr de vouloir supprimer ce produit ?')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/medicines/${id}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            alert('Produit supprim√© avec succ√®s!');
            // Remove from local catalog
            catalog = catalog.filter(p => p.id !== id);
            // Refresh the catalog display
            renderCatalog();
        } else {
            throw new Error('Failed to delete product');
        }
    } catch (error) {
        console.error('Error deleting product:', error);
        alert('Erreur lors de la suppression du produit: ' + error.message);
    }
}

function closeCatalog() {
  qs('#catalogModal').classList.remove('active');
}

async function loadCatalog() {
  try {
    const res = await fetch('/api/medicines');
    if (!res.ok) throw new Error('Failed to load medicines');
    
    const data = await res.json();
    catalog = data.map(p => ({
      id: p.id,
      name: p.name || '',
      category: p.category || '',
      price: parseFloat(p.price) || 0,
      dosage: p.dosage || '',
      manufacturer: p.manufacturer || '',
      originalPrice: parseFloat(p.originalPrice) || 0,
      image: p.image || '',
      stock: parseInt(p.stock) || 0
    }));
    
    renderCatalog();
  } catch (e) {
    console.error('Error loading medicines:', e);
    qs('#catalogItems').innerHTML = '<div style="padding:12px;color:#999">Impossible de charger les m√©dicaments</div>';
  }
}

function selectCatalogItem(index) {
    if (!filteredCatalog[index]) return;
    const product = filteredCatalog[index];
    
    // Check if product has sufficient stock
    if (product.stock <= 0) {
        alert(`‚ùå Stock √©puis√© pour ${product.name}`);
        return;
    }
    
    const container = qs('#itemsContainer');
    const last = container.lastElementChild;
    const desc = last.querySelector('.item-desc');
    
    // Create description with stock info
    let description = product.name;
    let stockIndicator = '';
    
    if (product.stock <= 10) {
        stockIndicator = ` ‚ö†Ô∏è (Stock: ${product.stock})`;
    } else {
        stockIndicator = ` ‚úÖ (Stock: ${product.stock})`;
    }
    
    if (desc && desc.value.trim() === '') {
        // Use existing empty row
        desc.value = description + stockIndicator;
        const price = last.querySelector('.item-price');
        price.value = product.price.toFixed(2);
        price.dataset.basePrice = product.price;
        last.querySelector('.item-tax').value = '';
        last.querySelector('.item-qty').value = 1;
        last.querySelector('.base-price-value').textContent = product.price.toFixed(2);
    } else {
        // Add new row
        addItem();
        const newRow = container.lastElementChild;
        newRow.querySelector('.item-desc').value = description + stockIndicator;
        newRow.querySelector('.item-price').value = product.price.toFixed(2);
        newRow.querySelector('.item-price').dataset.basePrice = product.price;
        newRow.querySelector('.item-tax').value = '';
        newRow.querySelector('.item-qty').value = 1;
        newRow.querySelector('.base-price-value').textContent = product.price.toFixed(2);
    }
    
    closeCatalog();
    generateInvoice();
}

// Helper function to update stock display in item row
function updateStockDisplay(row, stock) {
    let stockDisplay = row.querySelector('.stock-display');
    if (!stockDisplay) {
        stockDisplay = document.createElement('div');
        stockDisplay.className = 'stock-display';
        stockDisplay.style.marginTop = '4px';
        stockDisplay.style.fontSize = '12px';
        stockDisplay.style.color = '#666';
        row.querySelector('.adjustment-display').appendChild(stockDisplay);
    }
    
    let stockColor = '#00b894'; // Green for good stock
    let stockText = 'Stock suffisant';
    
    if (stock <= 0) {
        stockColor = '#ff7675'; // Red for out of stock
        stockText = 'Stock √©puis√©';
    } else if (stock <= 10) {
        stockColor = '#fdcb6e'; // Yellow for low stock
        stockText = `Stock faible: ${stock} unit√©s`;
    } else {
        stockText = `Stock disponible: ${stock} unit√©s`;
    }
    
    stockDisplay.innerHTML = `<span style="color: ${stockColor}; font-weight: bold;">üì¶ ${stockText}</span>`;
}

function addItem() {
    const container = qs('#itemsContainer');
    const newRow = document.createElement('div');
    newRow.className = 'item-row';
    newRow.innerHTML = `
        <input class="item-desc" placeholder="Nom + Dosage (ex: ENGYMYCINE 200 ML)">
        <input class="item-qty" type="number" min="1" value="1">
        <input class="item-price" type="number" step="0.01" data-base-price="0">
        <input class="item-tax" type="number" min="0" max="100" value="">
        <button onclick="removeItem(this)">√ó</button>
        <div class="adjustment-display">
            <div style="display:flex;gap:6px;flex-wrap:wrap">
                <button onclick="adjustPrice(this,-30)">-30%</button>
                <button onclick="adjustPrice(this,-20)">-20%</button>
                <button onclick="adjustPrice(this,-10)">-10%</button>
                <button onclick="adjustPrice(this,-5)">-5%</button>
                <button onclick="adjustPrice(this,-3)">-3%</button>
                <button onclick="adjustPrice(this,-2)">-2%</button>
                <button onclick="adjustPrice(this,0)">0%</button>
                <button onclick="adjustPrice(this,2)">+2%</button>
                <button onclick="adjustPrice(this,3)">+3%</button>
                <button onclick="adjustPrice(this,5)">+5%</button>
                <button onclick="adjustPrice(this,10)">+10%</button>
                <button onclick="adjustPrice(this,20)">+20%</button>
                <button onclick="adjustPrice(this,30)">+30%</button>
            </div>
            <div style="margin-top:6px" class="muted">
                Ajustement: <span class="adjustment-value">0%</span> | 
                Prix de base: <span class="base-price-value">0.00</span> DZD
            </div>
            <!-- Stock display will be added here dynamically -->
        </div>
    `;
    container.appendChild(newRow);
}

function removeItem(btn) {
    const c = qs('#itemsContainer');
    if (c.children.length > 1) {
        btn.parentElement.remove();
        generateInvoice();
    }
}

function adjustPrice(btn, percent) {
    const row = btn.closest('.item-row');
    const priceInput = row.querySelector('.item-price');
    let base = parseFloat(priceInput.dataset.basePrice) || parseFloat(priceInput.value) || 0;
    const newP = base * (1 + percent / 100);
    priceInput.value = newP.toFixed(2);
    row.querySelector('.adjustment-value').textContent = percent + '%';
    generateInvoice();
}

function closeCatalog() {
  qs('#catalogModal').classList.remove('active');
}

function renderCatalog() {
    const wrap = qs('#catalogItems');
    wrap.innerHTML = '';
    const query = (qs('#productSearch')?.value || '').toLowerCase();

    filteredCatalog = catalog.filter(p => 
        p.name.toLowerCase().includes(query) ||
        (p.category && p.category.toLowerCase().includes(query)) ||
        (p.manufacturer && p.manufacturer.toLowerCase().includes(query))
    );

    if (!filteredCatalog.length) {
        wrap.innerHTML = '<div style="padding:12px;color:#999;text-align:center">Aucun produit trouv√©</div>';
        return;
    }

    filteredCatalog.forEach((p, idx) => {
        const div = document.createElement('div');
        div.className = 'catalog-item';
        
        // Stock indicator with colors
        let stockColor = '#00b894';
        let stockBgColor = '#f8fff9';
        let stockText = `${p.stock} unit√©s`;
        let stockIcon = 'üì¶';
        
        if (p.stock <= 0) {
            stockColor = '#ff7675';
            stockBgColor = '#fff5f5';
            stockText = '√âpuis√©';
            stockIcon = '‚ùå';
        } else if (p.stock <= 10) {
            stockColor = '#fdcb6e';
            stockBgColor = '#fffbf0';
            stockText = `${p.stock} unit√©s (Faible)`;
            stockIcon = '‚ö†Ô∏è';
        }
        
        div.innerHTML = `
            <div style="cursor:pointer; flex: 1;" onclick="selectCatalogItem(${idx})">
                <div style="font-weight:700; margin-bottom: 4px;">${p.name}</div>
                <div class="meta" style="margin-bottom: 4px;">
                    ${p.category ? `Cat√©gorie: ${p.category} | ` : ''}
                    Prix: ${p.price.toFixed(2)} DZD
                </div>
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                    <span style="background: ${stockBgColor}; color: ${stockColor}; padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: bold; border: 1px solid ${stockColor}20;">
                        ${stockIcon} ${stockText}
                    </span>
                </div>
                ${p.manufacturer ? `<div class="meta">Fabricant: ${p.manufacturer}</div>` : ''}
                ${p.dosage ? `<div class="meta">Dosage: ${p.dosage}</div>` : ''}
            </div>
            <div style="display: flex; gap: 5px;">
                <button onclick="openEditProductForm(event, ${p.id})">‚úèÔ∏è</button>
                <button onclick="deleteProduct(${p.id})" style="background: #ff7675; color: white;">üóëÔ∏è</button>
            </div>
        `;
        wrap.appendChild(div);
    });
}

function selectCatalogItem(index) {
  if (!filteredCatalog[index]) return;
  const p = filteredCatalog[index];
  
  const container = qs('#itemsContainer');
  const last = container.lastElementChild;
  const desc = last.querySelector('.item-desc');
  
  if (desc && desc.value.trim() === '') {
    desc.value = p.name;
    const price = last.querySelector('.item-price');
    price.value = p.price.toFixed(2);
    price.dataset.basePrice = p.price;
    last.querySelector('.item-tax').value = p.tax || '';
    last.querySelector('.item-qty').value = 1;
    last.querySelector('.base-price-value').textContent = p.price.toFixed(2);
  } else {
    addItem();
    const nw = container.lastElementChild;
    nw.querySelector('.item-desc').value = p.name;
    nw.querySelector('.item-price').value = p.price.toFixed(2);
    nw.querySelector('.item-price').dataset.basePrice = p.price;
    nw.querySelector('.item-tax').value = p.tax || '';
    nw.querySelector('.item-qty').value = 1;
    nw.querySelector('.base-price-value').textContent = p.price.toFixed(2);
  }
  
  closeCatalog();
  generateInvoice();
}

function openAddProductForm() {
    console.log("üîÑ openAddProductForm() called");
    
    // First, make sure the modal is open
    const modal = document.getElementById('productFormModal');
    if (!modal) {
        console.error("‚ùå productFormModal not found!");
        return;
    }
    
    // Set editing state to null (creating new product)
    editingProductId = null;
    
    // Update the form title
    const titleElement = document.getElementById('productFormTitle');
    if (titleElement) {
        titleElement.textContent = "Ajouter un produit";
    } else {
        console.error("‚ùå productFormTitle element not found!");
    }
    
    // Clear all form fields safely
    const clearField = (id, defaultValue = '') => {
        const element = document.getElementById(id);
        if (element) {
            element.value = defaultValue;
        } else {
            console.warn(`‚ö†Ô∏è Form element ${id} not found`);
        }
    };
    
    // Clear all form fields
    clearField('productNameInput', '');
    clearField('productCategoryInput', '');
    clearField('productPriceInput', '');
    clearField('productDosageInput', '');
    clearField('productManufacturerInput', '');
    clearField('productOriginalPriceInput', '');
    clearField('productImageInput', '');
    clearField('productStockInput', '1');
    
    // Show the modal
    modal.classList.add('active');
    console.log("‚úÖ Add product form opened successfully");
}

function openEditProductForm(event, id) {
    event.stopPropagation();
    
    // Find the product in the catalog
    const product = catalog.find(p => p.id === id);
    if (!product) {
        alert("Produit introuvable dans le catalogue");
        return;
    }

    editingProductId = id;
    qs("#productFormTitle").textContent = "Modifier le produit";
    
    // Populate the form with product data (NO TAX)
    qs("#productNameInput").value = product.name || "";
    qs("#productCategoryInput").value = product.category || "";
    qs("#productPriceInput").value = product.price || "";
    qs("#productDosageInput").value = product.dosage || "";
    qs("#productManufacturerInput").value = product.manufacturer || "";
    qs("#productOriginalPriceInput").value = product.originalPrice || "";
    qs("#productImageInput").value = product.image || "";
    qs("#productStockInput").value = product.stock || 1;
    // TAX FIELD REMOVED
    
    qs("#productFormModal").classList.add("active");
}

function saveProduct() {
    const name = qs("#productNameInput").value.trim();
    const category = qs("#productCategoryInput").value.trim();
    const price = parseFloat(qs("#productPriceInput").value) || 0;
    const dosage = qs("#productDosageInput").value.trim();
    const manufacturer = qs("#productManufacturerInput").value.trim();
    const originalPrice = parseFloat(qs("#productOriginalPriceInput").value) || 0;
    const image = qs("#productImageInput").value.trim();
    const stock = parseInt(qs("#productStockInput").value) || 1;
    const tax = parseFloat(qs("#productTaxInput").value) || 0;

    if (!name) {
        alert("Veuillez entrer un nom de produit");
        return;
    }

    if (editingProductId) {
        const p = catalog.find(p => p.id === editingProductId);
        if (p) {
            p.name = name;
            p.category = category;
            p.price = price;
            p.dosage = dosage;
            p.manufacturer = manufacturer;
            p.originalPrice = originalPrice;
            p.image = image;
            p.stock = stock;
            p.tax = tax;
        }
    } else {
        const newId = catalog.length ? Math.max(...catalog.map(p => p.id)) + 1 : 1;
        catalog.push({ 
            id: newId, 
            name, 
            category, 
            price, 
            dosage, 
            manufacturer, 
            originalPrice, 
            image, 
            stock,
            tax 
        });
    }

    closeProductForm();
    renderCatalog();
}

function exportCatalogToJSON() {
  const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(catalog, null, 2));
  const a = document.createElement('a');
  a.href = dataStr;
  a.download = 'catalogue_produits.json';
  document.body.appendChild(a);
  a.click();
  a.remove();
}

// Function to import catalog from JSON file
function importCatalogFromJSON() {
    // Create file input element
    const fileInput = document.createElement('input');
    fileInput.type = 'file';
    fileInput.accept = '.json';
    fileInput.style.display = 'none';
    
    fileInput.onchange = async (event) => {
        const file = event.target.files[0];
        if (!file) return;
        
        try {
            const text = await file.text();
            const importedData = JSON.parse(text);
            
            // Validate the imported data
            if (!Array.isArray(importedData)) {
                throw new Error('Le fichier JSON doit contenir un tableau de produits');
            }
            
            // Ask for confirmation
            const confirmMessage = `Voulez-vous importer ${importedData.length} produit(s) ?\n\n` +
                                 `Cette action √©crasera votre catalogue actuel.`;
            
            if (!confirm(confirmMessage)) {
                return;
            }
            
            // Send each product to the backend
            let successCount = 0;
            let errorCount = 0;
            
            for (const product of importedData) {
                try {
                    const response = await fetch('/api/medicines', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(product)
                    });
                    
                    if (response.ok) {
                        successCount++;
                    } else {
                        errorCount++;
                    }
                } catch (error) {
                    errorCount++;
                }
            }
            
            // Show results
            alert(`Importation termin√©e !\n\n` +
                  `‚úÖ ${successCount} produit(s) import√©(s) avec succ√®s\n` +
                  `‚ùå ${errorCount} erreur(s)`);
            
            // Refresh the catalog
            await loadCatalog();
            
        } catch (error) {
            console.error('Error importing catalog:', error);
            alert('Erreur lors de l\'importation : ' + error.message);
        }
        
        // Clean up
        document.body.removeChild(fileInput);
    };
    
    // Add to DOM and trigger click
    document.body.appendChild(fileInput);
    fileInput.click();
}

// Items manipulation
function addItem() {
  const container = qs('#itemsContainer');
  const newRow = document.createElement('div');
  newRow.className = 'item-row';
  newRow.innerHTML = `
    <input class="item-desc" placeholder="Nom + Dosage (ex: ENGYMYCINE 200 ML)">
    <input class="item-qty" type="number" min="1" value="1">
    <input class="item-price" type="number" step="0.01" data-base-price="0">
    <input class="item-tax" type="number" min="0" max="100" value="">
    <button onclick="removeItem(this)">√ó</button>
    <div class="adjustment-display">
      <div style="display:flex;gap:6px;flex-wrap:wrap">
        <button onclick="adjustPrice(this,-30)">-30%</button>
        <button onclick="adjustPrice(this,-20)">-20%</button>
        <button onclick="adjustPrice(this,-10)">-10%</button>
        <button onclick="adjustPrice(this,-5)">-5%</button>
        <button onclick="adjustPrice(this,-3)">-3%</button>
        <button onclick="adjustPrice(this,-2)">-2%</button>
        <button onclick="adjustPrice(this,0)">0%</button>
        <button onclick="adjustPrice(this,2)">+2%</button>
        <button onclick="adjustPrice(this,3)">+3%</button>
        <button onclick="adjustPrice(this,5)">+5%</button>
        <button onclick="adjustPrice(this,10)">+10%</button>
        <button onclick="adjustPrice(this,20)">+20%</button>
        <button onclick="adjustPrice(this,30)">+30%</button>
      </div>
      <div style="margin-top:6px" class="muted">
        Ajustement: <span class="adjustment-value">0%</span> | 
        Prix de base: <span class="base-price-value">0.00</span> DZD
      </div>
    </div>
  `;
  container.appendChild(newRow);
}

function removeItem(btn) {
  const c = qs('#itemsContainer');
  if (c.children.length > 1) {
    btn.parentElement.remove();
    generateInvoice();
  }
}

function adjustPrice(btn, percent) {
  const row = btn.closest('.item-row');
  const priceInput = row.querySelector('.item-price');
  let base = parseFloat(priceInput.dataset.basePrice) || parseFloat(priceInput.value) || 0;
  const newP = base * (1 + percent / 100);
  priceInput.value = newP.toFixed(2);
  row.querySelector('.adjustment-value').textContent = percent + '%';
  generateInvoice();
}

// Invoice generation and preview
function generateInvoice() {
  const companySel = qs('#companySelect');
  const companyOpt = companySel.options[companySel.selectedIndex];
  const companyName = companyOpt ? companyOpt.textContent : 'Votre Entreprise';
  const companyAddress = companyOpt ? companyOpt.dataset.address || '' : '';
  
  qs('#previewCompanyName').textContent = companyName;
  qs('#previewCompanyAddress').innerHTML = (companyAddress || '').replace(/\n/g, '<br>');
  
  qs('#previewInvoiceNumber').textContent = 'FACTURE N¬∞ ' + (qs('#invoiceNumber').value || '---');
  
  const invoiceDate = qs('#invoiceDate').value || new Date().toISOString().split('T')[0];
  qs('#previewDate').textContent = new Date(invoiceDate).toLocaleDateString('fr-FR');
  
  const clientSel = qs('#clientSelect');
  const clientOpt = clientSel.options[clientSel.selectedIndex];
  qs('#previewClientName').textContent = clientOpt ? clientOpt.textContent : 'Nom du client';
  qs('#previewClientAddress').innerHTML = (clientOpt ? clientOpt.dataset.address || '' : '').replace(/\n/g, '<br>');
  
  const rows = qsa('.item-row');
  const items = [];
  let subtotal = 0, totalTax = 0;
  
  rows.forEach(r => {
    const desc = r.querySelector('.item-desc').value.trim();
    const qty = parseFloat(r.querySelector('.item-qty').value) || 0;
    const price = parseFloat(r.querySelector('.item-price').value) || 0;
    const tax = parseFloat(r.querySelector('.item-tax').value) || 0;
    
    if (desc && qty > 0) {
      const line = qty * price;
      const linTax = line * (tax / 100);
      items.push({ desc, qty, price, tax, line });
      subtotal += line;
      totalTax += linTax;
    }
  });
  
  const tbody = qs('#invoiceItems');
  tbody.innerHTML = '';
  
  if (items.length === 0) {
    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:#999;padding:18px">Aucun article ajout√©</td></tr>';
    qs('#totalsSection').style.display = 'none';
  } else {
    items.forEach(it => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${it.desc}</td>
        <td class="text-right">${it.qty}</td>
        <td class="text-right">${it.price.toFixed(2)} DZD</td>
        <td class="text-right">${it.tax}%</td>
        <td class="text-right">${it.line.toFixed(2)} DZD</td>
      `;
      tbody.appendChild(tr);
    });
    
    qs('#subtotal').textContent = subtotal.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + ' DZD';
    qs('#taxAmount').textContent = totalTax.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + ' DZD';
    qs('#total').textContent = (subtotal + totalTax).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + ' DZD';
    qs('#totalsSection').style.display = 'block';
  }
}

// Invoice saving
async function saveInvoice() {
    console.log("üîÑ saveInvoice() called with stock management");
    
    generateInvoice();
    const company_id = parseInt(qs('#companySelect').value) || null;
    const client_id = parseInt(qs('#clientSelect').value) || null;
    const number = qs('#invoiceNumber').value || '';
    const date = qs('#invoiceDate').value || new Date().toISOString().split('T')[0];
    const rows = qsa('.item-row');
    const items = [];
    let subtotal = 0, tax_total = 0;
    
    // First, collect all items and quantities
    const stockUpdates = [];
    
    rows.forEach(r => {
        const desc = r.querySelector('.item-desc').value.trim();
        const qty = parseFloat(r.querySelector('.item-qty').value) || 0;
        const price = parseFloat(r.querySelector('.item-price').value) || 0;
        const tax = parseFloat(r.querySelector('.item-tax').value) || 0;
        
        if (desc && qty > 0) {
            const line = qty * price;
            const linTax = line * (tax / 100);
            subtotal += line;
            tax_total += linTax;
            items.push({ desc, qty, price, tax, line });
            
            // Find the product in catalog to update stock
            const productName = desc.replace(/ ‚ö†Ô∏è \(Stock: \d+\)$/, '')
                                   .replace(/ ‚úÖ \(Stock: \d+\)$/, '')
                                   .replace(/ ‚ùå \(Stock: \d+\)$/, '')
                                   .trim();
            
            const product = catalog.find(p => p.name === productName);
            if (product) {
                stockUpdates.push({
                    productId: product.id,
                    productName: product.name,
                    quantity: qty,
                    currentStock: product.stock,
                    newStock: product.stock - qty
                });
            }
        }
    });
    
    if (items.length === 0) return alert('Ajoutez au moins un article');
    
    // Check stock availability before saving
    const outOfStockItems = stockUpdates.filter(update => update.newStock < 0);
    if (outOfStockItems.length > 0) {
        const outOfStockNames = outOfStockItems.map(item => 
            `${item.productName} (Stock actuel: ${item.currentStock}, Demand√©: ${item.quantity})`
        ).join('\n');
        
        alert(`‚ùå Stock insuffisant pour:\n${outOfStockNames}`);
        return;
    }
    
    const payload = {
        company_id,
        client_id,
        number,
        date,
        subtotal,
        tax_total,
        total: subtotal + tax_total,
        items,
        paid: false
    };
    
    try {
        let res;
        
        if (currentEditingInvoiceId) {
            // MISE √Ä JOUR d'une facture existante
            res = await fetch(`/api/invoices/${currentEditingInvoiceId}`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
        } else {
            // CR√âATION d'une nouvelle facture
            res = await fetch('/api/invoices', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
        }
        
        if (res.ok) {
            const data = await res.json();
            const action = currentEditingInvoiceId ? 'mise √† jour' : 'cr√©√©e';
            
            // ‚úÖ UPDATE STOCK AFTER SUCCESSFUL INVOICE SAVE
            await updateProductStocks(stockUpdates);
            
            alert(`Facture ${action} avec succ√®s! (ID: ${data.invoice?.id || currentEditingInvoiceId || 'N/A'})\n\nStock mis √† jour pour ${stockUpdates.length} produit(s).`);
            
            // R√©initialiser le formulaire
            resetInvoiceForm();
            
        } else {
            throw new Error('Server returned error: ' + res.status);
        }
    } catch (error) {
        console.error('Error saving invoice:', error);
        alert('Erreur lors de l\'enregistrement de la facture: ' + error.message);
    }
}

// Function to update product stocks after invoice save
async function updateProductStocks(stockUpdates) {
    console.log("üì¶ Updating product stocks:", stockUpdates);
    
    if (stockUpdates.length === 0) {
        console.log("No stock updates needed");
        return;
    }
    
    try {
        // Update each product's stock
        for (const update of stockUpdates) {
            // Get current product data
            const productResponse = await fetch(`/api/medicines/${update.productId}`);
            if (!productResponse.ok) {
                console.error(`Failed to fetch product ${update.productId}`);
                continue;
            }
            
            const product = await productResponse.json();
            
            // Update stock
            const updatedProduct = {
                ...product,
                stock: update.newStock
            };
            
            // Send update to backend
            const updateResponse = await fetch(`/api/medicines/${update.productId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(updatedProduct)
            });
            
            if (updateResponse.ok) {
                console.log(`‚úÖ Stock updated for ${update.productName}: ${update.currentStock} ‚Üí ${update.newStock}`);
                
                // Also update local catalog
                const localProductIndex = catalog.findIndex(p => p.id === update.productId);
                if (localProductIndex !== -1) {
                    catalog[localProductIndex].stock = update.newStock;
                }
            } else {
                console.error(`‚ùå Failed to update stock for ${update.productName}`);
            }
        }
        
        // Refresh catalog display
        await loadCatalog();
        renderCatalog();
        
        console.log("‚úÖ All stock updates completed");
        
    } catch (error) {
        console.error('Error updating stocks:', error);
        alert('Erreur lors de la mise √† jour des stocks: ' + error.message);
    }
}

// Enhanced function to find product by name (handles various formats)
function findProductByName(productName) {
    // Clean the product name by removing stock indicators
    const cleanName = productName
        .replace(/ ‚ö†Ô∏è \(Stock: \d+\)$/, '')
        .replace(/ ‚úÖ \(Stock: \d+\)$/, '')
        .replace(/ ‚ùå \(Stock: \d+\)$/, '')
        .replace(/ üì¶ \(Stock: \d+\)$/, '')
        .trim();
    
    // Try exact match first
    let product = catalog.find(p => p.name === cleanName);
    
    // If not found, try partial match
    if (!product) {
        product = catalog.find(p => cleanName.includes(p.name) || p.name.includes(cleanName));
    }
    
    // If still not found, try case-insensitive match
    if (!product) {
        product = catalog.find(p => 
            p.name.toLowerCase().includes(cleanName.toLowerCase()) || 
            cleanName.toLowerCase().includes(p.name.toLowerCase())
        );
    }
    
    return product;
}

// Invoice management
async function fetchInvoices() {
  try {
    const response = await fetch('/api/invoices');
    if (!response.ok) throw new Error('Failed to fetch invoices');
    return await response.json();
  } catch (error) {
    console.error('Error fetching invoices:', error);
    throw error;
  }
}

async function fetchInvoice(id) {
  try {
    const response = await fetch(`/api/invoices/${id}`);
    if (!response.ok) throw new Error('Failed to fetch invoice');
    return await response.json();
  } catch (error) {
    console.error('Error fetching invoice:', error);
    throw error;
  }
}

async function updateInvoice(id, data) {
  try {
    console.log('Updating invoice', id, 'with data:', data);
    
    const response = await fetch(`/api/invoices/${id}`, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });
    
    if (!response.ok) {
      const errorText = await response.text();
      throw new Error(`HTTP ${response.status}: ${errorText}`);
    }
    
    const result = await response.json();
    console.log('Update successful:', result);
    return result;
    
  } catch (error) {
    console.error('Error updating invoice:', error);
    throw error;
  }
}
async function deleteInvoice(id) {
  try {
    const response = await fetch(`/api/invoices/${id}`, { method: 'DELETE' });
    if (!response.ok) throw new Error('Failed to delete invoice');
    return true;
  } catch (error) {
    console.error('Error deleting invoice:', error);
    throw error;
  }
}

async function fetchClients() {
  try {
    const response = await fetch('/api/clients');
    if (!response.ok) throw new Error('Failed to fetch clients');
    return await response.json();
  } catch (error) {
    console.error('Error fetching clients:', error);
    return [];
  }
}

async function fetchCompanies() {
  try {
    const response = await fetch('/api/companies');
    if (!response.ok) throw new Error('Failed to fetch companies');
    return await response.json();
  } catch (error) {
    console.error('Error fetching companies:', error);
    return [];
  }
}

function openInvoiceManager() {
  loadInvoices();
  loadClientDebts();
  qs('#invoiceManagerModal').classList.add('active');
}

function closeInvoiceManager() {
  qs('#invoiceManagerModal').classList.remove('active');
}

async function loadInvoices() {
  try {
    const invoices = await fetchInvoices();
    const invoiceList = qs('#invoiceList');
    invoiceList.innerHTML = '';
    
    if (!invoices || invoices.length === 0) {
      invoiceList.innerHTML = '<div style="padding:12px;color:#999;text-align:center">Aucune facture trouv√©e</div>';
      return;
    }
    
    // Get client names for display
    const clients = await fetchClients();
    const clientMap = {};
    clients.forEach(client => {
      clientMap[client.id] = client.name || `Client ${client.id}`;
    });
    
    // Trier les factures par date (les plus r√©centes en premier)
    invoices.sort((a, b) => new Date(b.date) - new Date(a.date));
    
    invoices.forEach(invoice => {
      const div = document.createElement('div');
      div.className = 'catalog-item';
      div.style.cursor = 'pointer';
      div.setAttribute('data-invoice-id', invoice.id); // Stocker l'ID dans un attribut
      div.onclick = (event) => selectInvoice(invoice.id, event);
      
      const statusColor = invoice.paid ? '#00b894' : '#ff7675';
      const statusText = invoice.paid ? 'Pay√©e' : 'Impay√©e';
      const clientName = clientMap[invoice.client_id] || 'Client inconnu';
      
      div.innerHTML = `
        <div>
          <div style="font-weight:700">${invoice.number || 'Sans num√©ro'}</div>
          <div class="meta">Client: ${clientName} | Date: ${new Date(invoice.date).toLocaleDateString('fr-FR')}</div>
          <div class="meta">Total: ${(invoice.total || 0).toFixed(2)} DZD</div>
        </div>
        <div>
          <span style="background: ${statusColor}; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold;">
            ${statusText}
          </span>
        </div>
      `;
      
      invoiceList.appendChild(div);
    });

    // Si une facture √©tait s√©lectionn√©e avant le rechargement, la remettre en surbrillance
    if (currentSelectedInvoiceId) {
      highlightSelectedInvoice(currentSelectedInvoiceId);
    }
    
    // R√©appliquer le filtre apr√®s le chargement
    filterInvoices();
    
  } catch (error) {
    console.error('Error loading invoices:', error);
    qs('#invoiceList').innerHTML = '<div style="padding:12px;color:#ff7675;text-align:center">Erreur lors du chargement des factures</div>';
  }
}

async function loadClientDebts() {
  try {
    const clients = await fetchClients();
    const invoices = await fetchInvoices();
    const clientDebtsContainer = qs('#clientDebts');
    clientDebtsContainer.innerHTML = '';
    
    if (!clients || clients.length === 0) {
      clientDebtsContainer.innerHTML = '<div style="padding:12px;color:#999;text-align:center">Aucun client trouv√©</div>';
      return;
    }
    
    clients.forEach(client => {
      const clientInvoices = invoices.filter(inv => 
        inv.client_id == client.id && !inv.paid
      );
      
      const totalDebt = clientInvoices.reduce((sum, inv) => sum + (inv.total || 0), 0);
      
      if (totalDebt > 0) {
        const div = document.createElement('div');
        div.className = 'catalog-item';
        
        div.innerHTML = `
          <div>
            <div style="font-weight:700">${client.name || 'Sans nom'}</div>
            <div class="meta">${client.email || 'Pas d\'email'} | ${client.phone || 'Pas de t√©l√©phone'}</div>
          </div>
          <div style="font-weight:bold; color: #ff7675">
            ${totalDebt.toFixed(2)} DZD
          </div>
        `;
        
        clientDebtsContainer.appendChild(div);
      }
    });
    
    if (clientDebtsContainer.children.length === 0) {
      clientDebtsContainer.innerHTML = '<div style="padding:12px;color:#00b894;text-align:center">Aucune dette client</div>';
    }
  } catch (error) {
    console.error('Error loading client debts:', error);
    qs('#clientDebts').innerHTML = '<div style="padding:12px;color:#ff7675;text-align:center">Erreur lors du chargement des dettes</div>';
  }
}

async function selectInvoice(invoiceId, event) {
  currentSelectedInvoiceId = invoiceId;
  
  try {
    console.log('Loading invoice details for ID:', invoiceId);
    
    // Fetch invoice data
    const invoice = await fetchInvoice(invoiceId);
    if (!invoice) throw new Error('Invoice not found');
    console.log('Invoice loaded:', invoice);
    
    // Remove highlight from all items
    document.querySelectorAll('#invoiceList .catalog-item').forEach(item => {
      item.style.background = '';
      item.style.border = '';
    });
    
    // Highlight selected item
    if (event && event.currentTarget) {
      event.currentTarget.style.background = 'rgba(102, 126, 234, 0.1)';
      event.currentTarget.style.border = '2px solid #667eea';
    }
    
    // Get client and company names for display
    console.log('Fetching clients and companies...');
    const [clients, companies] = await Promise.all([
      fetchClients(),
      fetchCompanies()
    ]);
    
    console.log('Clients:', clients.length, 'Companies:', companies.length);
    
    const client = clients.find(c => c.id == invoice.client_id) || {};
    const company = companies.find(c => c.id == invoice.company_id) || {};
    
    console.log('Found client:', client.name, 'company:', company.name);
    
    // Update the detail display
    updateInvoiceDetailDisplay(invoice, client, company);
    
    // Show the detail panel
    qs('#invoiceDetail').style.display = 'block';
    
    console.log('Invoice details displayed successfully');
    
  } catch (error) {
    console.error('Error loading invoice details:', error);
    alert('Erreur lors du chargement des d√©tails de la facture: ' + error.message);
  }
}
async function testAllEndpoints() {
  try {
    console.log('Testing API endpoints...');
    
    // Test invoices
    const invoices = await fetchInvoices();
    console.log('‚úÖ Invoices endpoint working:', invoices.length, 'invoices');
    
    // Test single invoice
    if (invoices.length > 0) {
      const firstInvoice = await fetchInvoice(invoices[0].id);
      console.log('‚úÖ Single invoice endpoint working:', firstInvoice.id);
    }
    
    // Test clients
    const clients = await fetchClients();
    console.log('‚úÖ Clients endpoint working:', clients.length, 'clients');
    
    // Test companies
    const companies = await fetchCompanies();
    console.log('‚úÖ Companies endpoint working:', companies.length, 'companies');
    
    console.log('üéâ All API endpoints are working correctly!');
    return true;
    
  } catch (error) {
    console.error('‚ùå API test failed:', error);
    return false;
  }
}

// Run test when page loads
document.addEventListener('DOMContentLoaded', function() {
  console.log('App loaded, testing API endpoints...');
  testAllEndpoints();
});

function updateInvoiceDetailDisplay(invoice, client, company) {
  console.log('Updating detail display for invoice:', invoice);
  
  // S'assurer que l'√©l√©ment de d√©tail est visible
  const detailElement = qs('#invoiceDetail');
  if (!detailElement) {
    console.error('Invoice detail element not found!');
    return;
  }
  
  // NE JAMAIS CACHER l'√©l√©ment de d√©tail ici
  detailElement.style.display = 'block';
  
  try {
    // Mettre √† jour les informations de base
    qs('#detailCompanyName').textContent = company.name || 'Soci√©t√© non sp√©cifi√©e';
    qs('#detailCompanyAddress').innerHTML = (company.address || 'Adresse non sp√©cifi√©e').replace(/\n/g, '<br>');
    qs('#detailInvoiceNumber').textContent = `FACTURE N¬∞ ${invoice.number || '---'}`;
    qs('#detailInvoiceDate').textContent = new Date(invoice.date).toLocaleDateString('fr-FR');
    qs('#detailClientName').textContent = client.name || 'Client non sp√©cifi√©';
    qs('#detailClientAddress').innerHTML = (client.address || 'Adresse non sp√©cifi√©e').replace(/\n/g, '<br>');
    
    // Mettre √† jour les articles
    const itemsContainer = qs('#detailInvoiceItems');
    itemsContainer.innerHTML = '';
    
    if (invoice.items && invoice.items.length > 0) {
      invoice.items.forEach(item => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${item.desc}</td>
          <td class="text-right">${item.qty}</td>
          <td class="text-right">${(item.price || 0).toFixed(2)} DZD</td>
          <td class="text-right">${item.tax}%</td>
          <td class="text-right">${(item.line || 0).toFixed(2)} DZD</td>
        `;
        itemsContainer.appendChild(tr);
      });
    } else {
      itemsContainer.innerHTML = '<tr><td colspan="5" style="text-align:center;color:#999;padding:18px">Aucun article</td></tr>';
    }
    
    // Mettre √† jour les totaux
    const subtotal = invoice.subtotal || 0;
    const taxAmount = invoice.tax_total || 0;
    const total = invoice.total || 0;
    
    qs('#detailSubtotal').textContent = subtotal.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + ' DZD';
    qs('#detailTaxAmount').textContent = taxAmount.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + ' DZD';
    qs('#detailTotal').textContent = total.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + ' DZD';
    
    // Afficher/masquer la section des totaux
    qs('#detailTotalsSection').style.display = (invoice.items && invoice.items.length > 0) ? 'block' : 'none';
    
    // Mettre √† jour le bouton de statut pay√©
    const paidButton = document.querySelector('button[onclick="markInvoiceAsPaid()"]');
    if (paidButton) {
      if (invoice.paid) {
        paidButton.innerHTML = '‚Ü©Ô∏è Marquer comme impay√©e';
        paidButton.style.background = '#fdcb6e';
      } else {
        paidButton.innerHTML = '‚úÖ Marquer comme pay√©e';
        paidButton.style.background = '#00b894';
      }
    }
    
    console.log('Detail display updated successfully');
    
  } catch (error) {
    console.error('Error in updateInvoiceDetailDisplay:', error);
  }
}
function filterInvoices() {
  const searchTerm = qs('#invoiceSearch').value.toLowerCase();
  const statusFilter = qs('#statusFilter').value;
  const invoiceItems = document.querySelectorAll('#invoiceList .catalog-item');
  
  let hasVisibleItems = false;
  
  invoiceItems.forEach(item => {
    const text = item.textContent.toLowerCase();
    const statusSpan = item.querySelector('span');
    const isPaid = statusSpan && statusSpan.textContent.includes('Pay√©e');
    const isUnpaid = statusSpan && statusSpan.textContent.includes('Impay√©e');
    
    let matchesSearch = text.includes(searchTerm);
    let matchesStatus = true;
    
    if (statusFilter === 'paid') {
      matchesStatus = isPaid;
    } else if (statusFilter === 'unpaid') {
      matchesStatus = isUnpaid;
    }
    
    if (matchesSearch && matchesStatus) {
      item.style.display = 'flex';
      hasVisibleItems = true;
    } else {
      item.style.display = 'none';
    }
  });
  
  // Afficher un message si aucun r√©sultat
  const invoiceList = qs('#invoiceList');
  let noResultsMessage = invoiceList.querySelector('.no-results-message');
  
  if (!hasVisibleItems) {
    if (!noResultsMessage) {
      noResultsMessage = document.createElement('div');
      noResultsMessage.className = 'no-results-message';
      noResultsMessage.style.padding = '20px';
      noResultsMessage.style.color = '#999';
      noResultsMessage.style.textAlign = 'center';
      noResultsMessage.style.fontStyle = 'italic';
      invoiceList.appendChild(noResultsMessage);
    }
    
    let message = 'Aucune facture trouv√©e';
    if (statusFilter === 'paid') {
      message = 'Aucune facture pay√©e trouv√©e';
    } else if (statusFilter === 'unpaid') {
      message = 'Aucune facture impay√©e trouv√©e';
    }
    
    if (searchTerm) {
      message += ` avec la recherche "${searchTerm}"`;
    }
    
    noResultsMessage.textContent = message;
  } else if (noResultsMessage) {
    noResultsMessage.remove();
  }
}

// Ajouter cette variable globale
let currentEditingInvoiceId = null;

// Modifier la fonction editSelectedInvoice
async function editSelectedInvoice() {
  if (!currentSelectedInvoiceId) {
    alert('Veuillez s√©lectionner une facture √† modifier');
    return;
  }
  
  try {
    const invoice = await fetchInvoice(currentSelectedInvoiceId);
    if (!invoice) throw new Error('Invoice not found');
    
    // Stocker l'ID de la facture en cours d'√©dition
    currentEditingInvoiceId = currentSelectedInvoiceId;
    
    // Mettre √† jour le bouton de sauvegarde
    const saveButton = document.querySelector('button[onclick="saveInvoice()"]');
    if (saveButton) {
      saveButton.textContent = 'üíæ Mettre √† jour la facture';
      saveButton.style.background = '#00b894'; // Vert pour indiquer la modification
    }
    
    // Peupler le formulaire
    qs('#invoiceNumber').value = invoice.number || '';
    qs('#invoiceDate').value = invoice.date || new Date().toISOString().split('T')[0];
    
    if (invoice.company_id) {
      qs('#companySelect').value = invoice.company_id;
      updateCompanyPreview();
    }
    
    if (invoice.client_id) {
      qs('#clientSelect').value = invoice.client_id;
      updateClientPreview();
    }
    
    // Vider et remplir les articles
    const itemsContainer = qs('#itemsContainer');
    itemsContainer.innerHTML = '';
    
    if (invoice.items && invoice.items.length > 0) {
      invoice.items.forEach((item, index) => {
        addItem(); // Ajouter une nouvelle ligne
        
        const rows = itemsContainer.querySelectorAll('.item-row');
        const currentRow = rows[rows.length - 1];
        
        currentRow.querySelector('.item-desc').value = item.desc || '';
        currentRow.querySelector('.item-qty').value = item.qty || 1;
        currentRow.querySelector('.item-price').value = (item.price || 0).toFixed(2);
        currentRow.querySelector('.item-tax').value = item.tax || 0;
        
        // Mettre √† jour les donn√©es de base pour les ajustements
        const priceInput = currentRow.querySelector('.item-price');
        priceInput.dataset.basePrice = item.price || 0;
        currentRow.querySelector('.base-price-value').textContent = (item.price || 0).toFixed(2);
      });
    } else {
      addItem(); // Au moins une ligne vide
    }
    
    // Mettre √† jour l'aper√ßu
    generateInvoice();
    
    // Fermer le modal
    closeInvoiceManager();
    
    alert('Facture charg√©e pour modification. Cliquez sur "Mettre √† jour la facture" pour sauvegarder.');
  } catch (error) {
    console.error('Error loading invoice for editing:', error);
    alert('Erreur lors du chargement de la facture pour modification: ' + error.message);
  }
}

// Remplacer compl√®tement la fonction saveInvoice
async function saveInvoice() {
    console.log("üîÑ saveInvoice() called with stock management");
    
    generateInvoice();
    const company_id = parseInt(qs('#companySelect').value) || null;
    const client_id = parseInt(qs('#clientSelect').value) || null;
    const number = qs('#invoiceNumber').value || '';
    const date = qs('#invoiceDate').value || new Date().toISOString().split('T')[0];
    const rows = qsa('.item-row');
    const items = [];
    let subtotal = 0, tax_total = 0;
    
    // First, collect all items and quantities
    const stockUpdates = [];
    
    rows.forEach(r => {
        const desc = r.querySelector('.item-desc').value.trim();
        const qty = parseFloat(r.querySelector('.item-qty').value) || 0;
        const price = parseFloat(r.querySelector('.item-price').value) || 0;
        const tax = parseFloat(r.querySelector('.item-tax').value) || 0;
        
        if (desc && qty > 0) {
            const line = qty * price;
            const linTax = line * (tax / 100);
            subtotal += line;
            tax_total += linTax;
            items.push({ desc, qty, price, tax, line });
            
            // Find the product in catalog to update stock
            const product = findProductByName(desc);
            if (product) {
                stockUpdates.push({
                    productId: product.id,
                    productName: product.name,
                    quantity: qty,
                    currentStock: product.stock,
                    newStock: product.stock - qty
                });
            }
        }
    });
    
    if (items.length === 0) return alert('Ajoutez au moins un article');
    
    // Check stock availability before saving
    const outOfStockItems = stockUpdates.filter(update => update.newStock < 0);
    if (outOfStockItems.length > 0) {
        const outOfStockNames = outOfStockItems.map(item => 
            `${item.productName} (Stock actuel: ${item.currentStock}, Demand√©: ${item.quantity})`
        ).join('\n');
        
        alert(`‚ùå Stock insuffisant pour:\n${outOfStockNames}`);
        return;
    }
    
    const payload = {
        company_id,
        client_id,
        number,
        date,
        subtotal,
        tax_total,
        total: subtotal + tax_total,
        items,
        paid: false
    };
    
    try {
        let res;
        
        if (currentEditingInvoiceId) {
            // MISE √Ä JOUR d'une facture existante
            res = await fetch(`/api/invoices/${currentEditingInvoiceId}`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
        } else {
            // CR√âATION d'une nouvelle facture
            res = await fetch('/api/invoices', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
        }
        
        if (res.ok) {
            const data = await res.json();
            const action = currentEditingInvoiceId ? 'mise √† jour' : 'cr√©√©e';
            
            // ‚úÖ UPDATE STOCK AFTER SUCCESSFUL INVOICE SAVE
            await updateProductStocks(stockUpdates);
            
            alert(`Facture ${action} avec succ√®s! (ID: ${data.invoice?.id || currentEditingInvoiceId || 'N/A'})\n\nStock mis √† jour pour ${stockUpdates.length} produit(s).`);
            
            // R√©initialiser le formulaire
            resetInvoiceForm();
            
        } else {
            throw new Error('Server returned error: ' + res.status);
        }
    } catch (error) {
        console.error('Error saving invoice:', error);
        alert('Erreur lors de l\'enregistrement de la facture: ' + error.message);
    }
}

// Function to update product stocks after invoice save
async function updateProductStocks(stockUpdates) {
    console.log("üì¶ Updating product stocks:", stockUpdates);
    
    if (stockUpdates.length === 0) {
        console.log("No stock updates needed");
        return;
    }
    
    try {
        // Update each product's stock
        for (const update of stockUpdates) {
            // Get current product data
            const productResponse = await fetch(`/api/medicines/${update.productId}`);
            if (!productResponse.ok) {
                console.error(`Failed to fetch product ${update.productId}`);
                continue;
            }
            
            const product = await productResponse.json();
            
            // Update stock
            const updatedProduct = {
                ...product,
                stock: update.newStock
            };
            
            // Send update to backend
            const updateResponse = await fetch(`/api/medicines/${update.productId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(updatedProduct)
            });
            
            if (updateResponse.ok) {
                console.log(`‚úÖ Stock updated for ${update.productName}: ${update.currentStock} ‚Üí ${update.newStock}`);
                
                // Also update local catalog
                const localProductIndex = catalog.findIndex(p => p.id === update.productId);
                if (localProductIndex !== -1) {
                    catalog[localProductIndex].stock = update.newStock;
                }
            } else {
                console.error(`‚ùå Failed to update stock for ${update.productName}`);
            }
        }
        
        // Refresh catalog display
        await loadCatalog();
        renderCatalog();
        
        console.log("‚úÖ All stock updates completed");
        
    } catch (error) {
        console.error('Error updating stocks:', error);
        alert('Erreur lors de la mise √† jour des stocks: ' + error.message);
    }
}

// Enhanced function to find product by name (handles various formats)
function findProductByName(productName) {
    // Clean the product name by removing stock indicators
    const cleanName = productName
        .replace(/ ‚ö†Ô∏è \(Stock: \d+\)$/, '')
        .replace(/ ‚úÖ \(Stock: \d+\)$/, '')
        .replace(/ ‚ùå \(Stock: \d+\)$/, '')
        .replace(/ üì¶ \(Stock: \d+\)$/, '')
        .trim();
    
    // Try exact match first
    let product = catalog.find(p => p.name === cleanName);
    
    // If not found, try partial match
    if (!product) {
        product = catalog.find(p => cleanName.includes(p.name) || p.name.includes(cleanName));
    }
    
    // If still not found, try case-insensitive match
    if (!product) {
        product = catalog.find(p => 
            p.name.toLowerCase().includes(cleanName.toLowerCase()) || 
            cleanName.toLowerCase().includes(p.name.toLowerCase())
        );
    }
    
    return product;
}

// Function to reset invoice form
function resetInvoiceForm() {
    currentEditingInvoiceId = null;
    
    // R√©initialiser le bouton de sauvegarde
    const saveButton = document.querySelector('button[onclick="saveInvoice()"]');
    if (saveButton) {
        saveButton.textContent = 'üíæ Enregistrer la facture';
        saveButton.style.background = ''; // Retirer la couleur verte
    }
    
    // Vider le formulaire
    qs('#invoiceNumber').value = '';
    qs('#itemsContainer').innerHTML = '';
    addItem(); // Ajouter une ligne vide
    generateInvoice();
}

// Function to create new invoice
function newInvoice() {
    resetInvoiceForm();
    alert('Nouvelle facture cr√©√©e. Remplissez les informations.');
}

// Modifier le HTML pour ajouter un bouton "Nouvelle facture"
// Ajouter ce bouton dans la section des boutons :
// <button class="btn" onclick="newInvoice()" style="background: #00b894;">‚ûï Nouvelle facture</button>

async function deleteSelectedInvoice() {
  if (!currentSelectedInvoiceId) {
    alert('Veuillez s√©lectionner une facture √† supprimer');
    return;
  }
  
  try {
    // Get the invoice details first
    const invoice = await fetchInvoice(currentSelectedInvoiceId);
    if (!invoice) throw new Error('Invoice not found');
    
    // Ask if user wants to restore stock
    const restoreStock = confirm(
      `√ätes-vous s√ªr de vouloir supprimer la facture ${invoice.number} ?\n\n` +
      `Voulez-vous √©galement restaurer les quantit√©s dans le stock ?\n\n` +
      `‚Ä¢ Cliquez sur "OK" pour supprimer ET restaurer le stock\n` +
      `‚Ä¢ Cliquez sur "Annuler" pour supprimer sans restaurer le stock`
    );
    
    // If restoring stock, calculate the stock updates
    let stockRestorations = [];
    if (restoreStock && invoice.items && invoice.items.length > 0) {
      stockRestorations = await calculateStockRestorations(invoice.items);
    }
    
    // Delete the invoice
    await deleteInvoice(currentSelectedInvoiceId);
    
    // Restore stock if requested
    if (restoreStock && stockRestorations.length > 0) {
      await restoreProductStocks(stockRestorations);
      alert(`‚úÖ Facture supprim√©e et stock restaur√© avec succ√®s!\n\n${stockRestorations.length} produit(s) mis √† jour.`);
    } else {
      alert('‚úÖ Facture supprim√©e avec succ√®s!');
    }
    
    // Refresh the display
    loadInvoices();
    loadClientDebts();
    qs('#invoiceDetail').style.display = 'none';
    currentSelectedInvoiceId = null;
    
  } catch (error) {
    console.error('Error deleting invoice:', error);
    alert('Erreur lors de la suppression de la facture: ' + error.message);
  }
}

// Function to calculate stock restorations
async function calculateStockRestorations(items) {
  const stockRestorations = [];
  
  for (const item of items) {
    const product = findProductByName(item.desc);
    if (product) {
      stockRestorations.push({
        productId: product.id,
        productName: product.name,
        quantity: item.qty,
        currentStock: product.stock,
        newStock: product.stock + item.qty
      });
    }
  }
  
  return stockRestorations;
}

// Function to restore product stocks
async function restoreProductStocks(stockRestorations) {
  console.log("üì¶ Restoring product stocks:", stockRestorations);
  
  if (stockRestorations.length === 0) {
    console.log("No stock restorations needed");
    return;
  }
  
  try {
    // Update each product's stock
    for (const restoration of stockRestorations) {
      // Get current product data
      const productResponse = await fetch(`/api/medicines/${restoration.productId}`);
      if (!productResponse.ok) {
        console.error(`Failed to fetch product ${restoration.productId}`);
        continue;
      }
      
      const product = await productResponse.json();
      
      // Update stock
      const updatedProduct = {
        ...product,
        stock: restoration.newStock
      };
      
      // Send update to backend
      const updateResponse = await fetch(`/api/medicines/${restoration.productId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(updatedProduct)
      });
      
      if (updateResponse.ok) {
        console.log(`‚úÖ Stock restored for ${restoration.productName}: ${restoration.currentStock} ‚Üí ${restoration.newStock}`);
        
        // Also update local catalog
        const localProductIndex = catalog.findIndex(p => p.id === restoration.productId);
        if (localProductIndex !== -1) {
          catalog[localProductIndex].stock = restoration.newStock;
        }
      } else {
        console.error(`‚ùå Failed to restore stock for ${restoration.productName}`);
      }
    }
    
    // Refresh catalog display
    await loadCatalog();
    renderCatalog();
    
    console.log("‚úÖ All stock restorations completed");
    
  } catch (error) {
    console.error('Error restoring stocks:', error);
    alert('Erreur lors de la restauration des stocks: ' + error.message);
  }
}

// Replace your current markInvoiceAsPaid() with this function
async function markInvoiceAsPaid() {
  if (!currentSelectedInvoiceId) {
    alert('Veuillez s√©lectionner une facture');
    return;
  }
  
  try {
    const invoiceId = currentSelectedInvoiceId;
    const currentInvoice = await fetchInvoice(invoiceId);
    const newPaidStatus = !currentInvoice.paid;
    
    const action = newPaidStatus ? 'marquer comme pay√©e' : 'marquer comme impay√©e';
    const confirmationMessage = newPaidStatus 
      ? `√ätes-vous s√ªr de vouloir marquer la facture "${currentInvoice.number}" comme pay√©e ?\n\nCette action est r√©versible.`
      : `√ätes-vous s√ªr de vouloir marquer la facture "${currentInvoice.number}" comme impay√©e ?\n\nLe client r√©appara√Ætra dans la liste des dettes.`;
    
    // Demander confirmation
    if (!confirm(confirmationMessage)) {
      return;
    }
    
    console.log(`Changing invoice ${invoiceId} paid status to: ${newPaidStatus}`);
    
    // OPTION 1: Utiliser le nouvel endpoint d√©di√© (recommand√©)
    try {
      const response = await fetch(`/api/invoices/${invoiceId}/paid`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ paid: newPaidStatus })
      });
      
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${await response.text()}`);
      }
      
      const result = await response.json();
      console.log('Paid status update result:', result);
      
    } catch (endpointError) {
      console.warn('Dedicated endpoint failed, falling back to full update:', endpointError);
      
      // OPTION 2: Fallback vers l'endpoint complet
      const updateData = {
        company_id: currentInvoice.company_id,
        client_id: currentInvoice.client_id,
        number: currentInvoice.number,
        date: currentInvoice.date,
        subtotal: currentInvoice.subtotal,
        tax_total: currentInvoice.tax_total,
        total: currentInvoice.total,
        paid: newPaidStatus,
        items: currentInvoice.items || []
      };
      
      await updateInvoice(invoiceId, updateData);
    }
    
    // Rafra√Æchir l'affichage
    await refreshInvoiceDisplay(invoiceId);
    
    // Message de succ√®s
    const successMessage = newPaidStatus 
      ? `‚úÖ Facture marqu√©e comme pay√©e avec succ√®s`
      : `‚Ü©Ô∏è Facture marqu√©e comme impay√©e avec succ√®s`;
    
    // Notification visuelle temporaire
    showTempNotification(successMessage, newPaidStatus ? 'success' : 'warning');
    
  } catch (error) {
    console.error('Error updating invoice status:', error);
    alert('‚ùå Erreur lors de la modification du statut: ' + error.message);
  }
}

// Fonction pour afficher une notification temporaire
function showTempNotification(message, type = 'info') {
  const notification = document.createElement('div');
  notification.textContent = message;
  notification.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 12px 20px;
    border-radius: 8px;
    color: white;
    font-weight: bold;
    z-index: 10000;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    transition: opacity 0.3s ease;
  `;
  
  // Couleurs selon le type
  const colors = {
    success: '#00b894',
    warning: '#fdcb6e', 
    error: '#ff7675',
    info: '#667eea'
  };
  
  notification.style.background = colors[type] || colors.info;
  
  document.body.appendChild(notification);
  
  // Dispara√Ætre apr√®s 3 secondes
  setTimeout(() => {
    notification.style.opacity = '0';
    setTimeout(() => {
      if (notification.parentNode) {
        notification.parentNode.removeChild(notification);
      }
    }, 300);
  }, 3000);
}

// Fonction pour rafra√Æchir l'affichage
async function refreshInvoiceDisplay(invoiceId) {
  try {
    // R√©cup√©rer les donn√©es fra√Æches
    const updatedInvoice = await fetchInvoice(invoiceId);
    const clients = await fetchClients();
    const companies = await fetchCompanies();
    const client = clients.find(c => c.id == updatedInvoice.client_id) || {};
    const company = companies.find(c => c.id == updatedInvoice.company_id) || {};
    
    // Mettre √† jour l'affichage des d√©tails
    updateInvoiceDetailDisplay(updatedInvoice, client, company);
    
    // Mettre √† jour l'√©l√©ment dans la liste
    updateInvoiceInList(invoiceId, updatedInvoice);
    
    // Mettre √† jour les dettes clients
    await loadClientDebts();
    
  } catch (error) {
    console.error('Error refreshing display:', error);
  }
}

function updateInvoiceInList(invoiceId, invoice) {
  const invoiceElement = document.querySelector(`#invoiceList .catalog-item[data-invoice-id="${invoiceId}"]`);
  if (invoiceElement) {
    // Mettre √† jour le statut
    const statusSpan = invoiceElement.querySelector('span');
    if (statusSpan) {
      const isPaid = invoice.paid;
      statusSpan.style.background = isPaid ? '#00b894' : '#ff7675';
      statusSpan.textContent = isPaid ? 'Pay√©e' : 'Impay√©e';
    }
    
    // Mettre √† jour l'attribut data-paid pour le filtrage
    invoiceElement.setAttribute('data-paid', invoice.paid ? 'true' : 'false');
  }
}
// Fonction pour mettre √† jour l'√©l√©ment dans la liste
function updateInvoiceInList(invoiceId, invoice) {
  const invoiceElement = document.querySelector(`#invoiceList .catalog-item[data-invoice-id="${invoiceId}"]`);
  if (invoiceElement) {
    // Mettre √† jour le statut
    const statusSpan = invoiceElement.querySelector('span');
    if (statusSpan) {
      const isPaid = invoice.paid;
      statusSpan.style.background = isPaid ? '#00b894' : '#ff7675';
      statusSpan.textContent = isPaid ? 'Pay√©e' : 'Impay√©e';
    }
    
    // Mettre √† jour l'attribut data-paid pour le filtrage
    invoiceElement.setAttribute('data-paid', invoice.paid ? 'true' : 'false');
  }
}

// Ajoutez cette fonction pour rafra√Æchir l'affichage
async function refreshInvoiceDisplay(invoiceId) {
  try {
    // 1. R√©cup√©rer les donn√©es fra√Æches
    const updatedInvoice = await fetchInvoice(invoiceId);
    const clients = await fetchClients();
    const companies = await fetchCompanies();
    const client = clients.find(c => c.id == updatedInvoice.client_id) || {};
    const company = companies.find(c => c.id == updatedInvoice.company_id) || {};
    
    // 2. Mettre √† jour l'affichage des d√©tails
    updateInvoiceDetailDisplay(updatedInvoice, client, company);
    
    // 3. Mettre √† jour l'√©l√©ment dans la liste
    updateInvoiceInList(invoiceId, updatedInvoice);
    
    // 4. Mettre √† jour les dettes clients
    await loadClientDebts();
    
  } catch (error) {
    console.error('Error refreshing display:', error);
  }
}

// Ajoutez cette fonction pour mettre √† jour l'√©l√©ment dans la liste
function updateInvoiceInList(invoiceId, invoice) {
  const invoiceElement = document.querySelector(`#invoiceList .catalog-item[data-invoice-id="${invoiceId}"]`);
  if (invoiceElement) {
    // Mettre √† jour le statut
    const statusSpan = invoiceElement.querySelector('span');
    if (statusSpan) {
      const isPaid = invoice.paid;
      statusSpan.style.background = isPaid ? '#00b894' : '#ff7675';
      statusSpan.textContent = isPaid ? 'Pay√©e' : 'Impay√©e';
    }
    
    // Mettre √† jour l'attribut data-paid pour le filtrage
    invoiceElement.setAttribute('data-paid', invoice.paid ? 'true' : 'false');
  }
}


function highlightSelectedInvoice(invoiceId) {
  // Enlever la surbrillance de tous les √©l√©ments
  document.querySelectorAll('#invoiceList .catalog-item').forEach(item => {
    item.style.background = '';
    item.style.border = '';
  });
  
  // Trouver l'√©l√©ment par son attribut data-invoice-id
  const selectedElement = document.querySelector(`#invoiceList .catalog-item[data-invoice-id="${invoiceId}"]`);
  if (selectedElement) {
    selectedElement.style.background = 'rgba(102, 126, 234, 0.1)';
    selectedElement.style.border = '2px solid #667eea';
  }
}

// Export functions
function createPDFVersion() {
  const pdfElement = qs('#pdfInvoice');
  
  const companyName = qs('#previewCompanyName').textContent;
  const companyAddress = qs('#previewCompanyAddress').innerHTML;
  const invoiceNumber = qs('#previewInvoiceNumber').textContent;
  const invoiceDate = qs('#previewDate').textContent;
  const clientName = qs('#previewClientName').textContent;
  const clientAddress = qs('#previewClientAddress').innerHTML;
  
  let itemsHTML = '';
  const rows = qsa('#invoiceItems tr');
  rows.forEach(row => {
    const cells = row.querySelectorAll('td');
    if (cells.length === 5) {
      itemsHTML += `
        <tr>
          <td>${cells[0].textContent}</td>
          <td class="text-right">${cells[1].textContent}</td>
          <td class="text-right">${cells[2].textContent}</td>
          <td class="text-right">${cells[3].textContent}</td>
          <td class="text-right">${cells[4].textContent}</td>
        </tr>
      `;
    }
  });
  
  const pdfHTML = `
    <div class="pdf-header">
      <div class="pdf-company">
        <h2>${companyName}</h2>
        <div>${companyAddress.replace(/<br>/g, '<br>')}</div>
      </div>
      <div class="pdf-meta">
        <div style="text-align: left;" class="pdf-number">${invoiceNumber}</div>
        <div style="text-align: center;">Date: ${invoiceDate}</div>
      </div>
    </div>

    <div class="pdf-client">
      <div style="font-weight:bold;color:#667eea;margin-bottom:8px;">FACTURER √Ä :</div>
      <div class="client-name">${clientName}</div>
      <div class="client-address">${clientAddress.replace(/<br>/g, '<br>')}</div>
    </div>

    <table class="pdf-table">
      <thead>
        <tr>
          <th>Description</th>
          <th class="text-right">Quantit√©</th>
          <th class="text-right">Prix unitaire</th>
          <th class="text-right">TVA</th>
          <th class="text-right">Total HT</th>
        </tr>
      </thead>
      <tbody>
        ${itemsHTML}
      </tbody>
    </table>

    <div class="pdf-totals">
      <div class="pdf-total-row">
        <div>Sous-total HT:</div>
        <div>${qs('#subtotal').textContent}</div>
      </div>
      <div class="pdf-total-row">
        <div>TVA:</div>
        <div>${qs('#taxAmount').textContent}</div>
      </div>
      <div class="pdf-total-row pdf-grand-total">
        <div>TOTAL TTC:</div>
        <div>${qs('#total').textContent}</div>
      </div>
    </div>
  `;
  
  pdfElement.innerHTML = pdfHTML;
}

function exportToPDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  
  // Fonction utilitaire pour dessiner des rectangles avec coins arrondis
  function drawRoundedRect(doc, x, y, width, height, radius, fillColor, strokeColor) {
    if (fillColor) {
      doc.setFillColor(...fillColor);
      // Dessiner les 4 coins arrondis
      doc.circle(x + radius, y + radius, radius, 'F');
      doc.circle(x + width - radius, y + radius, radius, 'F');
      doc.circle(x + radius, y + height - radius, radius, 'F');
      doc.circle(x + width - radius, y + height - radius, radius, 'F');
      
      // Dessiner les rectangles pour combler le centre
      doc.rect(x, y + radius, width, height - (2 * radius), 'F');
      doc.rect(x + radius, y, width - (2 * radius), height, 'F');
    }
    
    if (strokeColor) {
      doc.setDrawColor(...strokeColor);
      // Dessiner les bords arrondis
      doc.circle(x + radius, y + radius, radius);
      doc.circle(x + width - radius, y + radius, radius);
      doc.circle(x + radius, y + height - radius, radius);
      doc.circle(x + width - radius, y + height - radius, radius);
      
      // Dessiner les lignes droites entre les coins
      doc.line(x + radius, y, x + width - radius, y);
      doc.line(x + radius, y + height, x + width - radius, y + height);
      doc.line(x, y + radius, x, y + height - radius);
      doc.line(x + width, y + radius, x + width, y + height - radius);
    }
  }

  // R√©cup√©rer les donn√©es depuis l'aper√ßu
  const companyName = qs('#previewCompanyName').textContent;
  const companyAddress = qs('#previewCompanyAddress').textContent;
  const invoiceNumber = qs('#previewInvoiceNumber').textContent;
  const invoiceDate = qs('#previewDate').textContent;
  const clientName = qs('#previewClientName').textContent;
  const clientAddress = qs('#previewClientAddress').textContent;

  // Couleurs du th√®me classic
  const primaryColor = [102, 126, 234]; // #667eea
  const textColor = [45, 52, 54]; // #2d3436
  const mutedColor = [99, 110, 114]; // #636e72
  const borderColor = [224, 224, 224]; // #e0e0e0

  // Position initiale
  let yPosition = 20;

  // En-t√™te avec style classic
  doc.setFillColor(...primaryColor);
  doc.rect(0, 0, 210, 8, 'F'); // Barre color√©e en haut comme dans le th√®me classic

  // Informations de l'entreprise (gauche)
  doc.setTextColor(...textColor);
  doc.setFontSize(18);
  doc.setFont(undefined, 'bold');
  doc.text(companyName, 20, yPosition);

  doc.setFontSize(10);
  doc.setFont(undefined, 'normal');
  const addressLines = companyAddress.split('\n');
  addressLines.forEach((line, index) => {
    doc.text(line, 20, yPosition + 10 + (index * 5));
  });

  // M√©tadonn√©es de la facture (droite)
  doc.setFontSize(16);
  doc.setFont(undefined, 'bold');
  doc.text(invoiceNumber, 190, yPosition, { align: 'right' });

  doc.setFontSize(10);
  doc.setFont(undefined, 'normal');
  doc.text(`Date: ${invoiceDate}`, 190, yPosition + 8, { align: 'right' });

  yPosition += 20;

  // Section client avec style classic (fond bleu clair + bordure gauche) avec coins arrondis
  drawRoundedRect(doc, 20, yPosition, 170, 30, 3, [242, 245, 255], null);

  // Bordure gauche
  // Bordure gauche arrondie (m√™me forme que le fond)
  const leftBorderWidth = 1;
doc.setFillColor(...primaryColor);
drawRoundedRect(doc, 20, yPosition, 3, 30, 1, primaryColor, null);

doc.setTextColor(...primaryColor);
doc.setFontSize(9);
doc.setFont(undefined, 'bold');
doc.text('FACTURER √Ä :', 35, yPosition + 8);

doc.setTextColor(...textColor);
doc.setFontSize(11);
doc.setFont(undefined, 'bold');
doc.text(clientName, 35, yPosition + 16);

doc.setFontSize(9);
doc.setFont(undefined, 'normal');
const clientAddressLines = clientAddress.split('\n');
clientAddressLines.forEach((line, index) => {
  doc.text(line, 35, yPosition + 22 + (index * 4));
});

  yPosition += 45;

  // En-t√™te du tableau avec coins arrondis
  drawRoundedRect(doc, 20, yPosition, 170, 10, 3, primaryColor, null);
  doc.setTextColor(255, 255, 255);
  doc.setFontSize(9);
  doc.setFont(undefined, 'bold');
  
  const columnHeaders = ['Description', 'Qt√©', 'Prix unitaire', 'TVA', 'Total HT'];
  const columnWidths = [80, 15, 25, 15, 35];
  let xPosition = 20;
  
  columnHeaders.forEach((header, index) => {
    const align = index === 0 ? 'left' : 'right';
    doc.text(header, xPosition + (index === 0 ? 5 : columnWidths[index] - 5), yPosition + 7, { align });
    xPosition += columnWidths[index];
  });

  yPosition += 10;

  // Articles du tableau avec fond altern√© et coins arrondis pour le contour global
  doc.setTextColor(...textColor);
  doc.setFontSize(9);
  doc.setFont(undefined, 'normal');

  const items = qsa('#invoiceItems tr');
  const tableBodyHeight = items.length * 8;
  
  // Dessiner le contour arrondi pour tout le corps du tableau
  if (items.length > 0) {
  drawRoundedRect(doc, 20, yPosition - 10, 170, tableBodyHeight + 10, 0, null, [255, 255, 255]);
  }

  items.forEach((item, index) => {
    if (index % 2 === 0) {
      doc.setFillColor(248, 249, 250); // Fond altern√© pour les lignes
      doc.rect(20, yPosition, 170, 8, 'F');
    }

    const cells = item.querySelectorAll('td');
    if (cells.length === 5) {
      let cellX = 20;
      
      // Description (align√©e √† gauche)
      doc.text(cells[0].textContent, cellX + 5, yPosition + 5, { maxWidth: columnWidths[0] - 10 });
      cellX += columnWidths[0];
      
      // Quantit√© (align√©e √† droite)
      doc.text(cells[1].textContent, cellX + columnWidths[1] - 5, yPosition + 5, { align: 'right' });
      cellX += columnWidths[1];
      
      // Prix unitaire (align√©e √† droite)
      doc.text(cells[2].textContent, cellX + columnWidths[2] - 5, yPosition + 5, { align: 'right' });
      cellX += columnWidths[2];
      
      // TVA (align√©e √† droite)
      doc.text(cells[3].textContent, cellX + columnWidths[3] - 5, yPosition + 5, { align: 'right' });
      cellX += columnWidths[3];
      
      // Total HT (align√©e √† droite)
      doc.text(cells[4].textContent, cellX + columnWidths[4] - 5, yPosition + 5, { align: 'right' });
    }

    // Ligne s√©paratrice entre les articles
    if (index < items.length - 1) {
      doc.setDrawColor(...borderColor);
      doc.line(25, yPosition + 8, 185, yPosition + 8);
    }

    yPosition += 8;
  });

  yPosition += 15;

  // Section des totaux avec style classic (fond d√©grad√© l√©ger) et coins arrondis
  const totalsWidth = 85;
  const totalsX = 190 - totalsWidth;
  
  drawRoundedRect(doc, totalsX - 10, yPosition, totalsWidth + 10, 60, 5, [248, 249, 255], );

  doc.setTextColor(...textColor);
  doc.setFontSize(12);

  // Sous-total
  doc.text('Sous-total HT:', totalsX, yPosition + 12);
  doc.text(qs('#subtotal').textContent, totalsX + totalsWidth - 5, yPosition + 12, { align: 'right' });

  // TVA
  doc.text('TVA:', totalsX, yPosition + 22);
  doc.text(qs('#taxAmount').textContent, totalsX + totalsWidth - 5, yPosition + 22, { align: 'right' });

  // Ligne de s√©paration avant le total
  doc.setDrawColor(...primaryColor);
  doc.line(totalsX - 5, yPosition + 30, totalsX + totalsWidth, yPosition + 30);

  // Total TTC
  doc.setFontSize(14);
  doc.setFont(undefined, 'bold');
  doc.setTextColor(...primaryColor);
  doc.text('TOTAL TTC:', totalsX, yPosition + 42);
  doc.text(qs('#total').textContent, totalsX + totalsWidth - 5, yPosition + 42, { align: 'right' });

  // Pied de page
  yPosition += 80;
  doc.setTextColor(...mutedColor);
  doc.setFontSize(8);
  doc.setFont(undefined, 'normal');
  doc.text('Facture g√©n√©r√©e avec G√©n√©rateur de Facture - Stacked', 105, yPosition, { align: 'center' });

  // Sauvegarder le PDF
  const fileName = `facture_${invoiceNumber.replace(/[^a-zA-Z0-9]/g, '_')}.pdf`;
  doc.save(fileName);
}
// Fonction utilitaire pour dessiner des rectangles avec coins arrondis
function drawRoundedRect(doc, x, y, width, height, radius, fillColor, strokeColor) {
  doc.setFillColor(...fillColor);
  if (strokeColor) doc.setDrawColor(...strokeColor);
  
  // Dessiner les 4 coins arrondis + le rectangle central
  doc.circle(x + radius, y + radius, radius, 'F'); // Coin sup√©rieur gauche
  doc.circle(x + width - radius, y + radius, radius, 'F'); // Coin sup√©rieur droit
  doc.circle(x + radius, y + height - radius, radius, 'F'); // Coin inf√©rieur gauche  
  doc.circle(x + width - radius, y + height - radius, radius, 'F'); // Coin inf√©rieur droit
  
  // Dessiner les rectangles pour combler le centre
  doc.rect(x, y + radius, width, height - (2 * radius), 'F'); // Rectangle vertical central
  doc.rect(x + radius, y, width - (2 * radius), height, 'F'); // Rectangle horizontal central
}
// Testez aussi cette fonction pour voir les donn√©es en temps r√©el :
function testData() {
    console.log("=== TEST DES DONN√âES ===");
    
    // Test des inputs de base
    console.log("Num√©ro facture:", document.getElementById("invoiceNumber").value);
    console.log("Date:", document.getElementById("invoiceDate").value);
    
    // Test des articles
    const rows = document.querySelectorAll('.item-row');
    console.log("Lignes d'articles:", rows.length);
    
    rows.forEach((row, i) => {
        const inputs = {
            desc: row.querySelector('.item-desc')?.value,
            qty: row.querySelector('.item-qty')?.value,
            price: row.querySelector('.item-price')?.value,
            tax: row.querySelector('.item-tax')?.value
        };
        console.log(`Ligne ${i}:`, inputs);
    });
}


// === COLLEZ CE CODE DANS LA CONSOLE ===
function debugItems() {
    console.log("=== DEBUG D√âTAILL√â DES ARTICLES ===");
    
    const itemRows = document.querySelectorAll('#itemsContainer .item-row');
    console.log("üìä Nombre de lignes trouv√©es:", itemRows.length);
    
    if (itemRows.length === 0) {
        console.error("‚ùå AUCUNE LIGNE TROUV√âE dans #itemsContainer !");
        console.log("√âl√©ments dans #itemsContainer:", document.getElementById('itemsContainer').innerHTML);
        return;
    }
    
    itemRows.forEach((row, index) => {
        console.log(`\n--- Ligne ${index + 1} ---`);
        
        // V√©rifier chaque input
        const descInput = row.querySelector('.item-desc');
        const qtyInput = row.querySelector('.item-qty');
        const priceInput = row.querySelector('.item-price');
        const taxInput = row.querySelector('.item-tax');
        
        console.log("‚úÖ Inputs trouv√©s:", {
            description: descInput ? 'OUI' : 'NON',
            quantit√©: qtyInput ? 'OUI' : 'NON',
            prix: priceInput ? 'OUI' : 'NON',
            tva: taxInput ? 'OUI' : 'NON'
        });
        
        if (descInput && qtyInput && priceInput) {
            const desc = descInput.value;
            const qty = qtyInput.value;
            const price = priceInput.value;
            const tax = taxInput ? taxInput.value : '0';
            
            console.log("üìù Valeurs actuelles:", {
                description: desc,
                quantit√©: qty,
                prix: price,
                tva: tax
            });
            
            console.log("üîç Validation:", {
                "Description non vide?": desc.trim() !== '',
                "Quantit√© > 0?": parseFloat(qty) > 0,
                "Prix > 0?": parseFloat(price) > 0,
                "Ligne valide?": desc.trim() !== '' && parseFloat(qty) > 0 && parseFloat(price) > 0
            });
        }
    });
    
    console.log("=== FIN DEBUG ===");
}

debugItems();

function testData() {
    console.log("=== TEST DES DONN√âES ===");
    
    // Test des inputs de base
    console.log("Num√©ro facture:", document.getElementById("invoiceNumber").value);
    console.log("Date:", document.getElementById("invoiceDate").value);
    
    // Test des articles
    const rows = document.querySelectorAll('.item-row');
    console.log("Lignes d'articles:", rows.length);
    
    rows.forEach((row, i) => {
        const inputs = {
            desc: row.querySelector('.item-desc')?.value,
            qty: row.querySelector('.item-qty')?.value,
            price: row.querySelector('.item-price')?.value,
            tax: row.querySelector('.item-tax')?.value
        };
        console.log(`Ligne ${i}:`, inputs);
    });
}
// === FIN DU CODE √Ä COLLER ===

// Ex√©cutez cette fonction :
debugItems();
// Appelez cette fonction dans la console pour debugger

function exportToWord() {
  generateInvoice();
  const invoice = qs('#invoice');
  const html = `<html><head><meta charset="utf-8"><title>Facture</title></head><body>${invoice.innerHTML}</body></html>`;
  const blob = new Blob([html], { type: 'application/msword' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `facture_${qs('#invoiceNumber').value || 'non-num'}.doc`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

function printInvoice() {
  generateInvoice();
  const invoice = document.getElementById('invoice');
  if (!invoice) return alert('Invoice not found!');

  const printWin = window.open('', '_blank', 'width=900,height=700');
  
  let styles = '';
  Array.from(document.querySelectorAll('style, link[rel="stylesheet"]')).forEach(node => {
    styles += node.outerHTML;
  });

  printWin.document.write(`
<html>
  <head>
    <title>Facture</title>
    ${styles}
    <style>
      body { margin: 0px; background: #fff; }
      
      .invoice-table {
        border-collapse: collapse;
        width: 100%;
      }
      
      .invoice-table th, 
      .invoice-table td { 
        padding: 12px 8px;
        border: none !important;
        text-align: left;
      }
      
      /* Header with thick border */
      .invoice-table thead tr {
        border-bottom: 2px solid #333 !important;
      }
      
      /* Regular rows with light borders */
      .invoice-table tbody tr {
        border-bottom: 1px solid #eee !important;
      }
      
      /* Highlight total row with thicker border */
      .invoice-table tbody tr.total-row {
        border-bottom: 2px solid #333 !important;
        font-weight: bold;
      }
      
      /* Remove border from very last row if needed */
      .invoice-table tbody tr:last-child {
        border-bottom: none !important;
      }
      
      .print-header { display: block !important; }
      .preview-tabs, .export-row, .btn { display: none !important; }
    </style>
  </head>
  <body>
    ${invoice.outerHTML}
  </body>
</html>

  `);

  printWin.document.close();
  printWin.focus();
  
  setTimeout(() => {
    printWin.print();
    printWin.close();
  }, 700);
}

// Theme switching
function changeTheme(theme) {
  const invoice = document.getElementById('invoice');
  const tabs = document.querySelectorAll('.preview-tab');
  
  invoice.className = 'preview-card';
  invoice.classList.add(theme);
  
  tabs.forEach(tab => tab.classList.remove('active'));
  event.target.classList.add('active');
}

// Event listeners
qs('#companySelect').addEventListener('change', updateCompanyPreview);
qs('#clientSelect').addEventListener('change', updateClientPreview);

document.addEventListener('click', e => {
  ['catalogModal', 'companyModal', 'companyFormModal', 'clientModal', 'clientFormModal', 'invoiceManagerModal', 'productFormModal'].forEach(id => {
    const el = qs('#' + id);
    if (el && e.target === el) el.classList.remove('active');
  });
});

document.addEventListener('input', (e) => {
  if (e.target.closest('.item-row') || e.target.id === 'invoiceNumber' || e.target.id === 'invoiceDate') generateInvoice();
});

function printInvoiceDetail() {
  if (!currentSelectedInvoiceId) {
    alert('Veuillez s√©lectionner une facture');
    return;
  }
  
  const invoiceDetail = qs('#invoiceDetail .preview-card');
  if (!invoiceDetail) return;

  const printWin = window.open('', '_blank', 'width=900,height=700');
  
  let styles = '';
  Array.from(document.querySelectorAll('style, link[rel="stylesheet"]')).forEach(node => {
    styles += node.outerHTML;
  });

  printWin.document.write(`
    <html>
      <head>
        <title>D√©tails de la Facture</title>
        ${styles}
        <style>
          body { margin: 20px; background: #fff; }
          .invoice-table th, .invoice-table td { border: 1px solid #ddd; padding: 8px; }
          .print-header { display: block !important; }
          .preview-tabs, .export-row, .btn { display: none !important; }
        </style>
      </head>
      <body>
        ${invoiceDetail.outerHTML}
      </body>
    </html>
  `);

  printWin.document.close();
  printWin.focus();
  
  setTimeout(() => {
    printWin.print();
    printWin.close();
  }, 300);
}
function drawRoundedRect(doc, x, y, w, h, r, bgColor = null, borderColor = null) {
  if (bgColor) doc.setFillColor(...bgColor);
  if (borderColor) doc.setDrawColor(...borderColor);

  doc.roundedRect(x, y, w, h, r, r, bgColor ? 'F' : 'S');
}
// Image upload and conversion functions
function handleImageUpload(input) {
    const file = input.files[0];
    const preview = document.getElementById('previewImage');
    const previewContainer = document.getElementById('imagePreview');
    const sizeInfo = document.getElementById('imageSizeInfo');
    const base64Input = document.getElementById('productImageInput');
    
    if (!file) {
        clearImage();
        return;
    }
    
    // Check if file is an image
    if (!file.type.match('image.*')) {
        alert('Veuillez s√©lectionner une image valide (JPEG, PNG, GIF, WEBP, AVIF, etc.)');
        clearImage();
        return;
    }
    
    // Check file size (max 2MB)
    if (file.size > 2 * 1024 * 1024) {
        alert('L\'image est trop volumineuse. Taille maximum: 2MB');
        clearImage();
        return;
    }
    
    // Show file size info
    const fileSize = (file.size / 1024).toFixed(2);
    sizeInfo.textContent = `Taille: ${fileSize} KB`;
    
    // Create FileReader to convert image to base64
    const reader = new FileReader();
    
    reader.onload = function(e) {
        // Set the base64 data to the hidden textarea
        base64Input.value = e.target.result;
        
        // Show preview
        preview.src = e.target.result;
        previewContainer.style.display = 'block';
        
        console.log('‚úÖ Image converted to base64, size:', base64Input.value.length, 'characters');
    };
    
    reader.onerror = function() {
        alert('Erreur lors de la lecture de l\'image');
        clearImage();
    };
    
    // Read the image file as base64
    reader.readAsDataURL(file);
}

function clearImage() {
    // Clear file input
    const fileInput = document.getElementById('productImageUpload');
    fileInput.value = '';
    
    // Clear base64 data
    const base64Input = document.getElementById('productImageInput');
    base64Input.value = '';
    
    // Hide preview
    const previewContainer = document.getElementById('imagePreview');
    previewContainer.style.display = 'none';
    
    console.log('üóëÔ∏è Image cleared');
}

// Update openAddProductForm to handle image field
function openAddProductForm() {
    console.log("üîÑ openAddProductForm() called");
    
    // First, make sure the modal is open
    const modal = document.getElementById('productFormModal');
    if (!modal) {
        console.error("‚ùå productFormModal not found!");
        return;
    }
    
    // Set editing state to null (creating new product)
    editingProductId = null;
    
    // Update the form title
    const titleElement = document.getElementById('productFormTitle');
    if (titleElement) {
        titleElement.textContent = "Ajouter un produit";
    }
    
    // Clear all form fields safely
    const clearField = (id, defaultValue = '') => {
        const element = document.getElementById(id);
        if (element) {
            element.value = defaultValue;
        }
    };
    
    // Clear all form fields
    clearField('productNameInput', '');
    clearField('productCategoryInput', '');
    clearField('productPriceInput', '');
    clearField('productDosageInput', '');
    clearField('productManufacturerInput', '');
    clearField('productOriginalPriceInput', '');
    clearField('productStockInput', '1');
    
    // Clear image specifically
    clearImage();
    
    // Show the modal
    modal.classList.add('active');
    console.log("‚úÖ Add product form opened successfully");
}

// Update openEditProductForm to handle image preview
function openEditProductForm(event, id) {
    event.stopPropagation();
    
    // Find the product in the catalog
    const product = catalog.find(p => p.id === id);
    if (!product) {
        alert("Produit introuvable dans le catalogue");
        return;
    }

    editingProductId = id;
    const titleElement = document.getElementById('productFormTitle');
    if (titleElement) {
        titleElement.textContent = "Modifier le produit";
    }
    
    // Populate the form with product data
    const setFieldValue = (id, value) => {
        const element = document.getElementById(id);
        if (element) element.value = value || '';
    };
    
    setFieldValue('productNameInput', product.name);
    setFieldValue('productCategoryInput', product.category);
    setFieldValue('productPriceInput', product.price);
    setFieldValue('productDosageInput', product.dosage);
    setFieldValue('productManufacturerInput', product.manufacturer);
    setFieldValue('productOriginalPriceInput', product.originalPrice);
    setFieldValue('productStockInput', product.stock || 1);
    
    // Handle image
    const base64Input = document.getElementById('productImageInput');
    const preview = document.getElementById('previewImage');
    const previewContainer = document.getElementById('imagePreview');
    const fileInput = document.getElementById('productImageUpload');
    
    if (product.image) {
        // Set base64 data
        base64Input.value = product.image;
        
        // Show preview
        preview.src = product.image;
        previewContainer.style.display = 'block';
        
        // Clear file input (since we're using existing base64)
        fileInput.value = '';
        
        // Show size info for existing image
        const sizeInfo = document.getElementById('imageSizeInfo');
        const sizeKB = (product.image.length / 1024).toFixed(2);
        sizeInfo.textContent = `Image existante - Taille: ${sizeKB} KB`;
    } else {
        clearImage();
    }
    
    const modal = document.getElementById('productFormModal');
    if (modal) {
        modal.classList.add('active');
    }
}
function exportInvoiceDetailToPDF() {
  if (!currentSelectedInvoiceId) {
    alert('Veuillez s√©lectionner une facture');
    return;
  }

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  // Fonction utilitaire pour dessiner des rectangles avec coins arrondis
  function drawRoundedRect(doc, x, y, width, height, radius, fillColor, strokeColor) {
    if (fillColor) {
      doc.setFillColor(...fillColor);
      // Dessiner les 4 coins arrondis
      doc.circle(x + radius, y + radius, radius, 'F');
      doc.circle(x + width - radius, y + radius, radius, 'F');
      doc.circle(x + radius, y + height - radius, radius, 'F');
      doc.circle(x + width - radius, y + height - radius, radius, 'F');
      
      // Dessiner les rectangles pour combler le centre
      doc.rect(x, y + radius, width, height - (2 * radius), 'F');
      doc.rect(x + radius, y, width - (2 * radius), height, 'F');
    }
    
    if (strokeColor) {
      doc.setDrawColor(...strokeColor);
      // Dessiner les bords arrondis
      doc.circle(x + radius, y + radius, radius);
      doc.circle(x + width - radius, y + radius, radius);
      doc.circle(x + radius, y + height - radius, radius);
      doc.circle(x + width - radius, y + height - radius, radius);
      
      // Dessiner les lignes droites entre les coins
      doc.line(x + radius, y, x + width - radius, y);
      doc.line(x + radius, y + height, x + width - radius, y + height);
      doc.line(x, y + radius, x, y + height - radius);
      doc.line(x + width, y + radius, x + width, y + height - radius);
    }
  }

  // R√©cup√©rer les donn√©es depuis le d√©tail de la facture
  const companyName = qs('#detailCompanyName').textContent;
  const companyAddress = qs('#detailCompanyAddress').textContent;
  const invoiceNumber = qs('#detailInvoiceNumber').textContent;
  const invoiceDate = qs('#detailInvoiceDate').textContent;
  const clientName = qs('#detailClientName').textContent;
  const clientAddress = qs('#detailClientAddress').textContent;

  // Couleurs du th√®me classic
  const primaryColor = [102, 126, 234]; // #667eea
  const textColor = [45, 52, 54]; // #2d3436
  const mutedColor = [99, 110, 114]; // #636e72
  const borderColor = [224, 224, 224]; // #e0e0e0

  // Position initiale
  let yPosition = 20;

  // En-t√™te avec style classic
  doc.setFillColor(...primaryColor);
  doc.rect(0, 0, 210, 8, 'F'); // Barre color√©e en haut

  // Informations de l'entreprise (gauche)
  doc.setTextColor(...textColor);
  doc.setFontSize(18);
  doc.setFont(undefined, 'bold');
  doc.text(companyName, 20, yPosition);

  doc.setFontSize(10);
  doc.setFont(undefined, 'normal');
  const addressLines = companyAddress.split('\n');
  addressLines.forEach((line, index) => {
    doc.text(line, 20, yPosition + 10 + (index * 5));
  });

  // M√©tadonn√©es de la facture (droite)
  doc.setFontSize(16);
  doc.setFont(undefined, 'bold');
  doc.text(invoiceNumber, 190, yPosition, { align: 'right' });

  doc.setFontSize(10);
  doc.setFont(undefined, 'normal');
  doc.text(`Date: ${invoiceDate}`, 190, yPosition + 8, { align: 'right' });

  yPosition += 20;

  // Section client avec style classic
  drawRoundedRect(doc, 20, yPosition, 170, 30, 3, [242, 245, 255], null);

  // Bordure gauche
  doc.setFillColor(...primaryColor);
  drawRoundedRect(doc, 20, yPosition, 3, 30, 1, primaryColor, null);

  doc.setTextColor(...primaryColor);
  doc.setFontSize(9);
  doc.setFont(undefined, 'bold');
  doc.text('FACTURER √Ä :', 35, yPosition + 8);

  doc.setTextColor(...textColor);
  doc.setFontSize(11);
  doc.setFont(undefined, 'bold');
  doc.text(clientName, 35, yPosition + 16);

  doc.setFontSize(9);
  doc.setFont(undefined, 'normal');
  const clientAddressLines = clientAddress.split('\n');
  clientAddressLines.forEach((line, index) => {
    doc.text(line, 35, yPosition + 22 + (index * 4));
  });

  yPosition += 45;

  // En-t√™te du tableau avec coins arrondis
  drawRoundedRect(doc, 20, yPosition, 170, 10, 3, primaryColor, null);
  doc.setTextColor(255, 255, 255);
  doc.setFontSize(9);
  doc.setFont(undefined, 'bold');
  
  const columnHeaders = ['Description', 'Qt√©', 'Prix unitaire', 'TVA', 'Total HT'];
  const columnWidths = [80, 15, 25, 15, 35];
  let xPosition = 20;
  
  columnHeaders.forEach((header, index) => {
    const align = index === 0 ? 'left' : 'right';
    doc.text(header, xPosition + (index === 0 ? 5 : columnWidths[index] - 5), yPosition + 7, { align });
    xPosition += columnWidths[index];
  });

  yPosition += 10;

  // Articles du tableau
  doc.setTextColor(...textColor);
  doc.setFontSize(9);
  doc.setFont(undefined, 'normal');

  const items = qsa('#detailInvoiceItems tr');
  const tableBodyHeight = items.length * 8;
  
  // Dessiner le contour arrondi pour tout le corps du tableau
  if (items.length > 0) {
    drawRoundedRect(doc, 20, yPosition - 10, 170, tableBodyHeight + 10, 0, null, [255, 255, 255]);
  }

  items.forEach((item, index) => {
    if (index % 2 === 0) {
      doc.setFillColor(248, 249, 250); // Fond altern√© pour les lignes
      doc.rect(20, yPosition, 170, 8, 'F');
    }

    const cells = item.querySelectorAll('td');
    if (cells.length === 5) {
      let cellX = 20;
      
      // Description (align√©e √† gauche)
      doc.text(cells[0].textContent, cellX + 5, yPosition + 5, { maxWidth: columnWidths[0] - 10 });
      cellX += columnWidths[0];
      
      // Quantit√© (align√©e √† droite)
      doc.text(cells[1].textContent, cellX + columnWidths[1] - 5, yPosition + 5, { align: 'right' });
      cellX += columnWidths[1];
      
      // Prix unitaire (align√©e √† droite)
      doc.text(cells[2].textContent, cellX + columnWidths[2] - 5, yPosition + 5, { align: 'right' });
      cellX += columnWidths[2];
      
      // TVA (align√©e √† droite)
      doc.text(cells[3].textContent, cellX + columnWidths[3] - 5, yPosition + 5, { align: 'right' });
      cellX += columnWidths[3];
      
      // Total HT (align√©e √† droite)
      doc.text(cells[4].textContent, cellX + columnWidths[4] - 5, yPosition + 5, { align: 'right' });
    }

    // Ligne s√©paratrice entre les articles
    if (index < items.length - 1) {
      doc.setDrawColor(...borderColor);
      doc.line(25, yPosition + 8, 185, yPosition + 8);
    }

    yPosition += 8;
  });

  yPosition += 15;

  // Section des totaux
  const totalsWidth = 85;
  const totalsX = 190 - totalsWidth;
  
  drawRoundedRect(doc, totalsX - 10, yPosition, totalsWidth + 10, 60, 5, [248, 249, 255]);

  doc.setTextColor(...textColor);
  doc.setFontSize(12);

  // Sous-total
  doc.text('Sous-total HT:', totalsX, yPosition + 12);
  doc.text(qs('#detailSubtotal').textContent, totalsX + totalsWidth - 5, yPosition + 12, { align: 'right' });

  // TVA
  doc.text('TVA:', totalsX, yPosition + 22);
  doc.text(qs('#detailTaxAmount').textContent, totalsX + totalsWidth - 5, yPosition + 22, { align: 'right' });

  // Ligne de s√©paration avant le total
  doc.setDrawColor(...primaryColor);
  doc.line(totalsX - 5, yPosition + 30, totalsX + totalsWidth, yPosition + 30);

  // Total TTC
  doc.setFontSize(14);
  doc.setFont(undefined, 'bold');
  doc.setTextColor(...primaryColor);
  doc.text('TOTAL TTC:', totalsX, yPosition + 42);
  doc.text(qs('#detailTotal').textContent, totalsX + totalsWidth - 5, yPosition + 42, { align: 'right' });

  // Pied de page
  yPosition += 80;
  doc.setTextColor(...mutedColor);
  doc.setFontSize(8);
  doc.setFont(undefined, 'normal');
  doc.text('Facture g√©n√©r√©e avec G√©n√©rateur de Facture - Stacked', 105, yPosition, { align: 'center' });

  // Sauvegarder le PDF
  const fileName = `facture_${invoiceNumber.replace(/[^a-zA-Z0-9]/g, '_')}.pdf`;
  doc.save(fileName);
}
</script>

</body>
</html>